<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ audit.name }} - Audit Details</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/ol@7.4.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/geotiff@1.0.0-beta.7/dist/geotiff.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol-geotiff@3.1.0/dist/ol-geotiff.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.4.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol/ol.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='audit_detail.css') }}?v={{ now }}">

</head>

<body>
<!-- Store s3BasePath for JS access -->
<div id="s3BasePathContainer" data-path="{{ s3_base_path }}" style="display:none;"></div>
<div id="plantDataContainer" data-plant-id="{{ plant._id }}" style="display:none;"></div>

<!-- Fullscreen Image Overlay -->
<div id="fullscreenOverlay" class="fullscreen-overlay">
    <img id="fullscreenImage" class="fullscreen-image" src="" alt="Fullscreen Image">
    <button class="close-fullscreen" onclick="closeFullscreen()">
        <svg fill="none" stroke="white" viewBox="0 0 24 24" width="32" height="32">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
    </button>
</div>

<div class="main-app">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="toggle-sidebar" onclick="window.toggleSidebar()">
            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </div>
        <div class="sidebar-logo">

            <img src="{{ url_for('static', filename='images/logo/logo1.png') }}" alt="Solar Plant Manager Logo">
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="/homepage"  title="Home">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                        </path>
                    </svg>
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="#" class="active" title="Thermography">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                        </path>
                    </svg>
                    <span>Thermography</span>
                </a>
            </li>
            <li>
                <a href="#"  title="IV Curve Testing">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"

                         stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <path d="M3 20 V4 H21"/> <!-- Axes -->
                        <path d="M3 18 C6 14, 12 8, 21 4"/> <!-- IV Curve -->
                    </svg>
                    <span>IV Curve Testing</span>
                </a>
            </li>

            <li>
                <a href="#" title="EL Testing">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"

                         stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <!-- Simple glowing cell icon -->
                        <rect x="4" y="4" width="16" height="16" rx="2" ry="2"/>
                        <path d="M4 10h16M4 14h16"/>
                        <path d="M10 4v16"/>
                    </svg>
                    <span>EL Testing</span>
                </a>
            </li>
            <li>
                <a href="#" title="Transmission Line">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"

                         stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <!-- Transmission pole with cross arms and wires -->
                        <path d="M12 3v18"/> <!-- Vertical pole -->
                        <path d="M6 6h12M4 10h16M6 14h12"/> <!-- Cross arms -->
                        <path d="M6 6l-2 4M18 6l2 4M6 14l-2-4M18 14l2-4"/> <!-- Wires -->
                    </svg>
                    <span>Transmission Line</span>
                </a>
            </li>
            <li>
                <a href="#" title="Data">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4">
                        </path>
                    </svg>
                    <span>Data</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="breadcrumb">
                <a href="/homepage">Plants</a> /
                <a href="/plant_detail/{{ plant.id }}">{{ plant.name }}</a> /
                <span>{{ audit.name }}</span> (Audit Detail)
            </div>
            <div class="header-actions">
                <div class="header-center">
                    <button class="top-btn" onclick="window.openOverview()">Overview</button>
                    <button class="top-btn active">Anomalies</button>
                    <button class="top-btn" onclick="window.openSiteDetails()">Site Details</button>
                    <button class="top-btn">Report</button>
                </div>
                <div class="user-dropdown">
                    <button class="user-btn" onclick="toggleUserDropdown()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span>{{ session.user_name or 'User' }}</span>
                    </button>
                    <div class="dropdown-menu" id="userDropdown">
                        <a href="/logout" class="dropdown-item">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Logout
                        </a>
                    </div>
                </div>
                    <button class="back-button" onclick="window.location.href='/homepage'">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back to Plants
                    </button>
                </div>
            </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Audit Header -->
            <!--                <div class="audit-header">-->
            <!--                    <h1 class="audit-title">{{ audit.name }}</h1>-->
            <!--                    <p class="audit-subtitle">{{ plant.name }} • Project Code: {{ audit.project_code }}</p>-->

            <!--                    <div class="audit-meta">-->
            <!--                        <div class="meta-item">-->
            <!--                            <div class="meta-label">Start Date</div>-->
            <!--                            <div class="meta-value">{{ audit.start_date }}</div>-->
            <!--                        </div>-->
            <!--                        <div class="meta-item">-->
            <!--                            <div class="meta-label">Completion Date</div>-->
            <!--                            <div class="meta-value">{{ audit.completion_date }}</div>-->
            <!--                        </div>-->
            <!--                        <div class="meta-item">-->
            <!--                            <div class="meta-label">Duration</div>-->
            <!--                        </div>-->
            <!--                        <div class="meta-item">-->
            <!--                            <div class="meta-label">Status</div>-->
            <!--                            <div class="meta-value">{{ audit.status.title() }}</div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                </div>-->

            <!-- Top Menu -->
            <!-- <div class="top-menu">
                <div class="menu-nav">
                    <button class="menu-btn active" onclick="showSection('drone')" id="droneBtn">
                        Drone Thermography
                    </button>
                    <button class="menu-btn" onclick="showSection('iv')" id="ivBtn" disabled>
                        IV Testing
                    </button>
                    <button class="menu-btn" onclick="showSection('el')" id="elBtn" disabled>
                        EL Testing
                    </button>
                    <button class="menu-btn" onclick="showSection('transmission')" id="transmissionBtn" disabled>
                        Transmission Line
                    </button>
                </div>
            </div> -->

            <!-- Drone Thermography Section -->
            <div id="droneSection" class="content-section">
                <!-- <div class="section-header">
                    <div class="section-title">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                        Drone Thermography Analysis
                    </div>
                </div> -->

                <div class="section-content">


                    <div class="container">


                        <!-- Left Panel -->
                        <div class="left-panel">
                            <div class="filter-group">
                                <label class="filter-label">Block Filter </label>
                                <select class="filter-select" id="blockFilter" onchange="filterData()">
                                    <option value="">All Blocks</option>

                                    {% for filter in block_filters %}
                                    <option value="{{filter}}">{{filter}}</option>

                                    {% endfor %}

                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Anomaly Filter </label>
                                <select class="filter-select" id="anomalyFilter" onchange="filterData()">
                                    <option value="">All Anomalies</option>
                                    {% for a_filter in anomaly_filter %}
                                    <option value="{{a_filter}}">{{a_filter}}</option>

                                    {% endfor %}

                                </select>
                            </div>
                            <div class="filter-group" style="display:none;">
                                <label class="filter-label">Anomaly Status </label>
                                <select class="filter-select" id="anomalyStatusFilter" onchange="filterData()">
                                    <option value="">All Anomalies</option>
                                    <option value="pending">Pending</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                            </div>
                            <div class="search-bar">
                                <input type="text" class="search-input" placeholder="Search...">
                                <button class="anomalies-btn">🔍 Anomalies</button>

                            </div>

                            <div class="results-count">
                                Showing <strong> {{ anomalies|length }} </strong> anomalies
                            </div>

                            <div class="inspection-list">

                                {% for anomaly in anomalies %}
                                <div class="inspection-item">
                                    <div class="inspection-title" data-anomaly='{{ anomaly|tojson|safe }}'
                                         onclick="handleAnomalyClick(this)">
                                        #{{ anomaly.properties['Image name'].split('.')[0] }} ({{
                                        anomaly.properties.ID }}{% if anomaly.properties.inverter %}, Inverter-{{
                                        anomaly.properties.inverter }}{% endif %}{% if anomaly.properties.scb %},
                                        SCB-{{ anomaly.properties.scb }}{% endif %}{% if anomaly.properties.String
                                        %}, String-{{ anomaly.properties.String }}{% endif %}{% if
                                        anomaly.properties.panel %}, Module-{{ anomaly.properties.panel }}{% endif
                                        %})
                                    </div>
                                    <div class="inspection-subtitle">
                                        <span class="status-dot status-red"></span>{{ anomaly.properties.Anomaly }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Map Panel -->
                        <div class="map-panel">
                            <!-- <div class="map-container"> -->

                            <div id="map">

                                <div class="map-controls">
                                    <button class="map-btn active" id="btnVisual">Visual</button>
                                    <button class="map-btn " id="btnThermal">Thermal</button>

                                    </button>
                                </div>
                            </div>

                            <button class="map-btn toggle-geojson" onclick="toggleGeojson()">
                                Hide Anamoly
                            </button>

                            <!-- </div> -->


                        </div>

                        <!-- Right Panel -->
                        <div class="right-panel">

                            <div id="divATop" class="main_right">
                                <div class="date-selector">{{ audit.name }}</div>

                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div class="stat-number">{{ anomalies|length }}</div>
                                        <div class="stat-label">Anomalies</div>
                                    </div>
                                    <div class="stat-item">

                                        <div class="stat-number">{{ plant.total_modules_inspected }}</div>
                                        <div class="stat-label">Modules Inspected</div>

                                    </div>
                                </div>


                                <!-- <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Healthy</span>
                                        <div class="detail-value">{{ plant.total_modules_inspected -
                                            anomalies|length }}</div>

                                    </div>
                                </div> -->
                                <!--
                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Client</span>
                                        <div class="detail-value">{{ plant.name }}</div>

                                    </div>
                                </div> -->

                                <!-- <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">AC Capacity</span>
                                        <span class="detail-value">{{ plant.ac_capacity }}</span>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">DC Capacity</span>
                                        <span class="detail-value">{{ plant.dc_capacity }}</span>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Start Date</span>
                                        <span class="detail-value">{{audit.start_date}}</span>
                                    </div>
                                </div>
                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Completion Date</span>
                                        <span class="detail-value">{{audit.completion_date}}</span>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Weather</span>
                                        <span class="detail-value">Clear, Sunny</span>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Location</span>
                                        <span class="detail-value">Khetakhali, Gujarat 364001</span>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Plant Coordinates</span>
                                        <span class="detail-value">{{ plant.latitude }}, {{ plant.longitude
                                            }}</span>

                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                    </div>
                                </div> -->
                                <div class="grid-container">

                                    {% for anomaly, count in anomaly_count.items() %}
                                    <div class="grid-item">
                                        <div class="value"
                                             style="color: {{ fault_colors.get(anomaly, '#999999') }};">{{ count }}
                                        </div>
                                        <div class="label"
                                             style="color: {{ fault_colors.get(anomaly, '#999999') }};">{{ anomaly }}
                                        </div>
                                    </div>
                                    {% endfor %}

                                    <!-- Add additional rows similarly -->
                                </div>


                            </div>

                            <div id="divABottom" class="selected-data-section hidden">
                                <div class="selected-data-section-content" id="anomalyDetails">
                                    <!-- <img class="upper-section"
                                        src="{{s3_base_path}}"
                                        alt="Data Check" /> -->


                                    <!-- <div id="anomalyDetails" class="lower-section">

                                    </div> -->
                                </div>
                            </div>


                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- Other Sections (Placeholder for future implementation) -->
    <div id="ivSection" class="content-section hidden">
        <div class="section-header">
            <div class="section-title">IV Testing Analysis</div>
        </div>
        <div class="section-content">
            <div class="empty-state">
                <h3>IV Testing Coming Soon</h3>
                <p>This feature will be enabled after the website goes live.</p>
            </div>
        </div>
    </div>

    <div id="elSection" class="content-section hidden">
        <div class="section-header">
            <div class="section-title">EL Testing Analysis</div>
        </div>
        <div class="section-content">
            <div class="empty-state">
                <h3>EL Testing Coming Soon</h3>
                <p>This feature will be enabled after the website goes live.</p>
            </div>
        </div>
    </div>

    <div id="transmissionSection" class="content-section hidden">
        <div class="section-header">
            <div class="section-title">Transmission Line Analysis</div>
        </div>
        <div class="section-content">
            <div class="empty-state">
                <h3>Transmission Line Testing Coming Soon</h3>
                <p>This feature will be enabled after the website goes live.</p>
            </div>
        </div>
    </div>
</div>
</div>
</div>


<script>
        // Add this at the beginning of your script section
        document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.querySelector('.toggle-sidebar svg');

            if (sidebar && mainContent && toggleBtn) {
                // Collapse sidebar by default
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');

                // Update toggle button icon
                toggleBtn.style.transform = 'rotate(180deg)';
            }
        });

        // toggleSidebar function is now defined in audit_detail.js

        // Section switching functionality
        function showSection(sectionId) {
            const sections = ['map-section', 'anomalies-section', 'reports-section'];
            const section = document.getElementById(sectionId);

            if (!section) return; // Exit if section doesn't exist

            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('active');
                }
            });

            section.classList.add('active');
        }

        // Initialize sections
        document.addEventListener('DOMContentLoaded', function () {
            // Show map section by default
            const mapSection = document.getElementById('map-section');
            if (mapSection) {
                mapSection.classList.add('active');
            }

            // Add click handlers for section buttons
            const sectionButtons = document.querySelectorAll('.section-btn');
            sectionButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        showSection(sectionId);
                    }
                });
            });
        });


        function filterAnomalyShowVector(anomalyFilter) {
            //
            const filteredRawFeatures = anomalyFilter
            const feature = {
                "Cell": "#FF0000",
                "Multi Cell": "#FFA500",
                "Bypass Diode": "#9C27B0",
                "Short Circuit": "#000000",
                "String Offline": "#FF1A94",
                "Module Power Mismatch": "#65E667",
                "Shading": "#E77148",
                "Plant Found": "#2E7D32",
                "Other": "#00BFFF",
                "Junction Box": "#BFC494",
                "Physical Damage": "#C2185B",
                "Module Missing": "#FFFFFF",
                "Module Offline": "#FF1493"
            };


            const format = new ol.format.GeoJSON();

            // Filter raw GeoJSON first (optional, if your original is geojsonData)
            // const filteredRawFeatures = geojsonData.features.filter(f => {
            //     return !anomalyFilter || f.properties.Anomaly === anomalyFilter;
            // });

            // Create a FeatureCollection
            const filteredGeoJSON = {
                type: "FeatureCollection",
                features: filteredRawFeatures
            };

            // ✅ Convert to ol.Feature[]
            const filteredFeatures = format.readFeatures(filteredGeoJSON, {
                dataProjection: 'EPSG:4326',
                featureProjection: 'EPSG:4326'
            });

            // ✅ Add to map
            vectorSource.clear();

            filteredFeatures.forEach(feature => {
                const anomaly = feature.get('Anomaly'); // works if `properties` were properly parsed
                const color = fault_colors[anomaly] || '#999999';

                feature.setStyle(new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 6,
                        fill: new ol.style.Fill({ color }),
                        stroke: new ol.style.Stroke({ color: '#fff', width: 1 })
                    })
                }));

                vectorSource.addFeature(feature);
            });

        };




        // Filter functionality
        function filterData() {
            try {
                const blockFilter = document.getElementById('blockFilter').value;
                const anomalyFilter = document.getElementById('anomalyFilter').value;
                const anomalyStatusFilter = document.getElementById('anomalyStatusFilter').value;
                let audit_id_value = "{{ audit._id }}"

                // Get all inspection items
                const inspectionItems = document.querySelectorAll('.inspection-item');

                console.log("--audit_id_value", audit_id_value)

                let visibleCount = 0;

                // Create a new source for the filtered features
                const newSource = new ol.source.Vector();

                // Get all features from the original source
                // const allFeatures = vectorLayer.getSource().getFeatures();

                const formData = new FormData();
                formData.append('block', blockFilter);
                formData.append('an', anomalyFilter);
 formData.append('anStatus', anomalyStatusFilter);

                // Create and configure XMLHttpRequest
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `/api/get_geojson/${audit_id_value}`, true);

                // Set up event handlers
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        try {
                            const newGeoJSONData = JSON.parse(xhr.responseText);
                            const resultsCount = document.querySelector('.results-count');
                            if (resultsCount) {
                                resultsCount.innerHTML = `Showing <strong>${newGeoJSONData.length}</strong> anomalies`;
                            }
                            visibleCount = newGeoJSONData.length
                            // Update the vector source with new features
                            const format = new ol.format.GeoJSON();
                            const newFeatures = format.readFeatures({
                                type: "FeatureCollection",
                                features: newGeoJSONData
                            }, {
                                dataProjection: 'EPSG:4326',
                                featureProjection: 'EPSG:4326'
                            });

                            // Clear existing features and add new ones
                            const source = vectorLayer.getSource();

                            vectorLayer.getSource().clear();
                            vectorLayer.getSource().addFeatures(newFeatures);

                            // Update the global geojsonData variable
                            geojsonData = {
                                type: "FeatureCollection",
                                features: newGeoJSONData
                            };
                            console.log("coming here", newGeoJSONData)
                            // Auto zoom to the extent of the new features
                            const extent = source.getExtent();
                            if (extent && extent.every(Number.isFinite)) {
                                console.log("---log")
                                map.getView().fit(extent, {
                                    padding: [20, 20, 20, 20],
                                    duration: 1000
                                });
                            }


                            // Show success message
                            // alert('GeoJSON data refreshed successfully!');
                        } catch (error) {
                            console.error('Error parsing response:', error);
                            alert('Failed to parse response data. Please try again.');
                        }
                    } else {
                        alert('Failed to refresh data. Server returned status: ' + xhr.status);
                    }
                };

                xhr.onerror = function () {
                    console.error('Request failed');
                    alert('Failed to refresh data. Please check your connection and try again.');
                };

                // Send the request
                xhr.send(formData);


                let anyFilterData = []
                // Filter and add features to the new source
                // allFeatures.forEach(feature => {
                //     const properties = feature.getProperties();
                //     const block = properties.Block;
                //     const anomalyType = properties.Anomaly;
                //     const blockMatch = !blockFilter || block === blockFilter.toString();
                //     const anomalyMatch = !anomalyFilter || anomalyType === anomalyFilter;

                //     if (blockMatch && anomalyMatch) {
                //         console.log("---anomalyMatch", properties)
                //         anyFilterData.push(properties)
                //         const color = fault_colors[anomalyType] || '#999999';

                //         // Create a new feature with the same properties
                //         const newFeature = new ol.Feature({
                //             geometry: feature.getGeometry(),
                //             ...properties
                //         });

                //         // Set the style for the new feature
                //         newFeature.setStyle(new ol.style.Style({
                //             image: new ol.style.Circle({
                //                 radius: 6,
                //                 fill: new ol.style.Fill({
                //                     color: color
                //                 }),
                //                 stroke: new ol.style.Stroke({
                //                     color: '#fff',
                //                     width: 1
                //                 })
                //             })
                //         }));

                //         // Add the feature to the new source
                //         newSource.addFeature(newFeature);
                //         visibleCount++;
                //     }
                // });
                // filterAnomalyShowVector(anyFilterData)

                // console.log("---newSource", newSource)

                // Update the vector layer with the new source
                // vectorLayer.setSource(newSource);


                // const filtered = allFeatures.filter(f => selectedDefects.includes(f.get('Anomaly')));
                // vectorSource.clear();  // Remove old features
                // vectorSource.addFeatures(filtered);  // Add filtered ones

                inspectionItems.forEach(item => {
                    try {
                        const anomalyData = JSON.parse(item.querySelector('.inspection-title').getAttribute('data-anomaly'));
                        const block = anomalyData.properties.Block;
                        const anomalyType = anomalyData.properties.Anomaly;

                        // Check if item matches both filters
                        const blockMatch = !blockFilter || block === blockFilter.toString();
                        const anomalyMatch = !anomalyFilter || anomalyType === anomalyFilter;

                        // Show/hide item based on filter matches
                        if (blockMatch && anomalyMatch) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    } catch (parseError) {
                        console.error('Error parsing anomaly data:', parseError);
                        // Hide items with invalid data
                        item.style.display = 'none';
                    }
                });

                // Update the results count
                // const resultsCount = document.querySelector('.results-count');
                // if (resultsCount) {
                //     resultsCount.innerHTML = `Showing <strong>${visibleCount}</strong> anomalies`;
                // }

                // Force a redraw of the vector layer
                // vectorLayer.changed();


            } catch (err) {
                console.error('Error in filterData:', err);
            }
        }

        // Toggle anomaly status
        async function toggleAnomalyStatus(auditId, anomalyId, toggleElement, statusValue) {
            const isResolved = toggleElement.classList.contains('resolved');

            const newStatus = statusValue//isResolved ? 'pending' : 'resolved';
            try {
                const response = await fetch(`/api/anomalies/${auditId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'anomaly_id': anomalyId,
                        status: newStatus
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Update UI
                    // toggleElement.classList.toggle(statusValue);
                    // const statusLabel = toggleElement.nextElementSibling;
                    // statusLabel.textContent = newStatus === 'resolved' ? 'Resolved' : 'Pending';
                    // alert(result.message);
                    // Create new button HTML based on new status
                    //             const oppositeStatus = newStatus === 'resolved' ? 'pending' : 'resolved';
                    //             const newButtonHTML = `
                    // <button class="action-button ${oppositeStatus}-btn" onclick="toggleAnomalyStatus('${auditId}', '${anomalyId}', this, '${oppositeStatus}')">
                    //     ${oppositeStatus.charAt(0).toUpperCase() + oppositeStatus.slice(1)}
                    // </button>`;

                    //             // Replace the entire container's innerHTML
                    //             toggleElement.parentElement.innerHTML = newButtonHTML;

                    //             alert(result.message);
                    const oppositeStatus = newStatus === 'resolved' ? 'pending' : 'resolved';

                    const newButtonContainerHTML = `
        <div class="button-container">
            <button class="action-button ${oppositeStatus}-btn" onclick="toggleAnomalyStatus('${auditId}', '${anomalyId}', this, '${oppositeStatus}')">
                ${oppositeStatus.charAt(0).toUpperCase() + oppositeStatus.slice(1)}
            </button>
        </div>`;

                    // Replace the full button container
                    const buttonContainer = toggleElement.closest('.button-container');
                    buttonContainer.outerHTML = newButtonContainerHTML;

                    alert(result.message);

                } else {
                    alert('Failed to update status: ' + result.message);
                }
                // location.reload();
            } catch (error) {
                console.error('Error updating anomaly status:', error);
                alert('Error updating status. Please try again.');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            // Show drone section by default
            showSection('drone');

            // Select the first inspection item by default
            const inspectionItems = document.querySelectorAll('.inspection-item');
            if (inspectionItems && inspectionItems.length > 0) {
                const firstItem = inspectionItems[0];
                const titleElement = firstItem.querySelector('.inspection-title');
                if (titleElement) {
                    // Trigger click on the first inspection item
                    handleAnomalyClick(titleElement);
                }
            }
            
            // // Add click event listeners to inspection items
            // const inspectionItems = document.querySelectorAll('.inspection-item');
            // console.log("---inspectionItems",inspectionItems)
            // inspectionItems.forEach(item => {
            //     item.addEventListener('click', handleInspectionItemClick);
            // });
        });

        // Function to handle inspection item clicks
        function handleInspectionItemClick(event) {
            // Remove selected class from all items
            document.querySelectorAll('.inspection-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selected class to clicked item
            this.classList.add('selected');

            const title = this.querySelector('.inspection-title').textContent.trim();
            const subtitle = this.querySelector('.inspection-subtitle').textContent.trim();
            const alertMessage = `Title: ${title}\nType: ${subtitle}`;
            alert("som" + alertMessage);
        }

        // Add this function at the beginning of your script section
        function showAnomalyDetails(anomaly) {
            const details = {
                'Image Name': anomaly.properties['image name'].split('.')[0],
                'Block': anomaly.properties.block,
                'Inverter': anomaly.properties.inverter,
                'SCB': anomaly.properties.scb,
                'String': anomaly.properties.string,
                'Module': anomaly.properties.panel,
                'Anomaly Type': anomaly.properties.anomaly_type,
                'Confidence': anomaly.properties.confidence
            };

            let message = 'Anomaly Details:\n\n';
            for (const [key, value] of Object.entries(details)) {
                message += `${key}: ${value}\n`;
            }

            // Add complete anomaly object for debugging
            console.log('Complete Anomaly Object:', anomaly);
            alert("Anomaly Details:\n" + message + "\nComplete object logged to console");
        }

        function loadAnomalies() {
            fetch('/get_anomalies/{{audit.id}}')
                .then(response => response.json())
                .then(data => {
                    anomalyData = data;
                    anomalyMarkers = data.map(anomaly => {
                        const marker = L.marker([anomaly.geometry.coordinates[1], anomaly.geometry.coordinates[0]], {
                            icon: L.divIcon({
                                className: 'anomaly-marker',
                                html: `<div class="marker-content">${anomaly.properties.anomaly_type}</div>`
                            })
                        });

                        // Add click handler here where marker is created
                        marker.on('click', function (e) {
                            showAnomalyDetails(anomaly);
                        });

                        return marker;
                    });
                    anomalyMarkers.forEach(marker => marker.addTo(map));
                });
        }

        function handleAnomalyClick(element) {
            // Get the clicked item
            const clickedItem = element.closest('.inspection-item');
            console.log("---element", element)

            // Check if the clicked item is already selected
            if (clickedItem.classList.contains('selected')) {
                // If already selected, deselect it
                clickedItem.classList.remove('selected');

                // Show the top panel and hide the bottom panel
                const divA = document.getElementById('divATop');
                const divB = document.getElementById('divABottom');
                divA.classList.remove('hidden');
                divB.classList.add('hidden');
                
                // Reset map view to show all features
                const extent = vectorLayer.getSource().getExtent();
                // Reset styles on all map features
                vectorLayer.getSource().getFeatures().forEach(f => f.setStyle(null));
                
                if (extent && extent.every(Number.isFinite)) {
                    map.getView().fit(extent, {
                        padding: [20, 20, 20, 20],
                    });
                }
                return; 
            }

            // If not selected, proceed with normal selection
            // Remove 'selected' class from all items
            document.querySelectorAll('.inspection-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add 'selected' class to the clicked item
            clickedItem.classList.add('selected');

            // Get the anomaly data from the data attribute
            const anomalyDataString = element.getAttribute('data-anomaly');

            const divA = document.getElementById('divATop');
            const divB = document.getElementById('divABottom');
            divA.classList.add('hidden');
            divB.classList.remove('hidden');
            const validJsonString = anomalyDataString.replace(/'/g, '"');
            const anomalyData = JSON.parse(validJsonString);
            showLoader();

            let Latitude = anomalyData.properties.Latitude
            let Longitud = anomalyData.properties.Longitude
            let image_name = anomalyData.properties['name']

            // Add small delay to show loader, then process data
            setTimeout(() => {
                displayAnomalyData(anomalyData);
            }, 500);

            // Zoom to and highlight on map
            zoomToTile(Latitude, Longitud, image_name);
        }


        function handleAnomalyClickMap(data_anomaly) {
            // Get the anomaly data from the data attribute
            const anomalyDataString = data_anomaly //element.getAttribute('data-anomaly');

            // Now you have access to the full anomaly object
            const divA = document.getElementById('divATop');
            const divB = document.getElementById('divABottom');
            divA.classList.add('hidden');
            divB.classList.remove('hidden');
            
            const anomalyData = { "properties": data_anomaly };
            showLoader();

            let Latitude = anomalyData.properties.Latitude;
            let Longitud = anomalyData.properties.Longitude;
            let image_name = anomalyData.properties['name'];
            
            // Find and highlight the corresponding item in the list
            highlightListItem(image_name);
            
            console.log("---image_name", image_name)

            // Add small delay to show loader, then process data
            setTimeout(() => {
                displayAnomalyData(anomalyData);
            }, 500);
            console.log("zoom leve")
            zoomToTile(Latitude, Longitud, image_name)



        }

        function zoomToTile(lat, lon, imageName) {
            const coordinate = [lon, lat];
            let zoomLevel = 21
            view.setCenter([lon, lat]);
            view.setZoom(zoomLevel);
            console.log("---log outside", lon, lat, imageName)
            if (!imageName) {
                return
            }
            const highlightStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'black',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(0, 0, 0, 0.7)' // darker black with 70% opacity
                })
            });
            // Reset styles
            vectorLayer.getSource().getFeatures().forEach(f => f.setStyle(null));

            const matchedFeatures = vectorLayer.getSource().getFeatures().filter(f => {
                return f.get('name') === imageName;
            });

            if (matchedFeatures.length === 0) {
                console.warn('No feature found with image name:', imageName);
                return;
            }

            matchedFeatures.forEach(f => f.setStyle(highlightStyle));

            // Zoom to first matching feature
            const geometry = matchedFeatures[0].getGeometry();
            const extent = geometry.getExtent();
            // view.fit(extent, { maxZoom: zoomLevel, duration: 500 });
        }

        // Function to find and highlight the corresponding item in the anomaly list
        function highlightListItem(imageName) {
            if (!imageName) return;
            
            // Remove selected class from all items
            document.querySelectorAll('.inspection-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Find the list item with matching image name
            const inspectionItems = document.querySelectorAll('.inspection-item');
            let foundItem = null;
            
            inspectionItems.forEach(item => {
                try {
                    const titleElement = item.querySelector('.inspection-title');
                    if (!titleElement) return;
                    
                    const anomalyDataString = titleElement.getAttribute('data-anomaly');
                    if (!anomalyDataString) return;
                    
                    const validJsonString = anomalyDataString.replace(/'/g, '"');
                    const anomalyData = JSON.parse(validJsonString);
                    
                    if (anomalyData.properties['name'] === imageName) {
                        // Found the matching item
                        foundItem = item;
                        // Add selected class
                        item.classList.add('selected');
                        
                        // Scroll the item into view if it's not visible
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                } catch (error) {
                    console.error('Error parsing anomaly data:', error);
                }
            });
            
            return foundItem;
        }



        function displayAnomalyData(anomalyData) {
            let properties = anomalyData.properties
            const detailsContainer = document.getElementById('anomalyDetails');
            const s3BasePath = "{{ s3_base_path }}";
            const imageName = properties['Image name'] || properties['Image na'] || 'N/A';
            const imagePath = imageName !== 'N/A' ? `${s3BasePath}/zip_images/${imageName}` : '{{ url_for("static", filename="images/data_check.png") }}';
            let audit_id_value = "{{ audit._id }}"
            const resolve_status = anomalyData.resolve_status
            console.log("log data coming", resolve_status)

            const detailsHTML = `
                <div class="image-container">
                    <img class="upper-section"
                        src="${imagePath}"
                        alt="Anomaly Image"
                        onerror="this.src='{{ url_for('static', filename='images/data_check.png') }}'" />
                    <button class="download-btn" onclick="downloadImage('${imagePath}', '${imageName}')" title="Download Image">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                    </button>
                    <button class="fullscreen-btn" onclick="openFullscreen('${imagePath}')" title="View Fullscreen">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path>
                        </svg>
                    </button>
                </div>
                <hr>
                <div class="detail-boxes-container">
                    <div class="detail-box">
                        <span class="detail-label">Anomaly Type</span>
                        <span class="detail-value">${properties.Anomaly}</span>
                    </div>

                    <div class="detail-box">
                        <span class="detail-label">Severity</span>
                        <span class="detail-value">${properties.Severity}</span>
                    </div>

                  <div class="detail-box">
                        <span class="detail-label">Irradiance</span>
                        <span class="detail-value">${properties['Irradian']}</span>
                    </div>

                     <div class="detail-box">
                        <span class="detail-label">ΔT(T2 - T1)</span>
                        <span class="detail-value">${properties['Hotspot']}</span>
                    </div>


                    <div class="detail-box">
                        <span class="detail-label">Lat,Long</span>
                        <span class="detail-value">${properties['Latitude']}, ${properties['Longitude']} <br/>
                        <a title="View on map" href="https://maps.google.com/?q=${properties['Latitude']},${properties['Longitude']}" target="_blank"><svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-map"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7l6 -3l6 3l6 -3v13l-6 3l-6 -3l-6 3v-13" /><path d="M9 4v13" /><path d="M15 7v13" /></svg></a>
                        </span>
                    </div>

                    <div class="detail-box">
                        <span class="detail-label">Date Time</span>
                        <span class="detail-value">${properties['Date']}, ${properties['Time']}</span>
                    </div>

                   
                

                </div>
                 <div class="detail-box">
                        <span class="detail-label">Localisation</span>
                        <span class="detail-value">${properties['ID']}</span>
                    </div>

                <div class="button-container">
                    ${resolve_status === 'resolved' ?
                    `<button class="action-button pending-btn" onclick="toggleAnomalyStatus('${audit_id_value}', '${imageName}', this, 'pending')">
                            Pending
                        </button>` :
                    `<button class="action-button resolve-btn" onclick="toggleAnomalyStatus('${audit_id_value}', '${imageName}', this, 'resolved')">
                            Resolve
                        </button>`
                }
                </div>
            `;

            detailsContainer.innerHTML = detailsHTML;
        }

        function showLoader() {

            const detailsContainer = document.getElementById('anomalyDetails');



            // Show loader in the details container
            detailsContainer.innerHTML = `
                <div class="loader-container">
                    <div class="loader"></div>
                    <div class="loader-text">Loading anomaly details...</div>
                </div>
            `;
        }

        function toggleGeojson() {
            // Don't allow toggling if in thermal mode


            const button = document.querySelector('.toggle-geojson');
            const isVisible = vectorLayer.getVisible();

            vectorLayer.setVisible(!isVisible);
            button.classList.toggle('active');

            // Update button text and state
            if (!isVisible) {
                button.textContent = 'Hide Anamoly';
                button.setAttribute('data-state', 'visible');
            } else {
                button.textContent = 'Show Anamoly';
                button.setAttribute('data-state', 'hidden');
            }
        }

        // Initialize button state on page load
        document.addEventListener('DOMContentLoaded', function () {
            const button = document.querySelector('.toggle-geojson');
            const isVisible = vectorLayer.getVisible();

            if (isVisible) {
                button.classList.add('active');
                button.textContent = 'Hide Anamoly';
                button.setAttribute('data-state', 'visible');
            } else {
                button.classList.remove('active');
                button.textContent = 'Show Anamoly';
                button.setAttribute('data-state', 'hidden');
            }
        });

        // Add this new function to handle GeoJSON data refresh


        // Initialize global variables
        let geojsonData = {
            type: "FeatureCollection",
            features: {{ geojson | tojson | safe }}
        };
        let selectedFeature = null;

        const fault_colors = {{ fault_colors | safe }};
        const visual_ortho = {{ visual_ortho | tojson | safe }};
        const thermal_ortho = {{ thermal_ortho | tojson | safe }};
        const s3BaseURL = "{{s3_tif_base_url}}";

        console.log("thermal_ortho", thermal_ortho)

        const view = new ol.View({
            projection: 'EPSG:4326',
            center: [77.4095, 14.2476],
            zoom: 17
        });

        // Satellite Base Layer (ESRI World Imagery)
        const baseLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attributions: 'Tiles © Esri'
            })
        });

        const format = new ol.format.GeoJSON();
        const features = format.readFeatures(geojsonData, {
            dataProjection: 'EPSG:4326',
            featureProjection: 'EPSG:4326'
        });


        const visualLayers = visual_ortho.map((url, index) => new ol.layer.WebGLTile({
            source: new ol.source.GeoTIFF({
                sources: [{
                    url: `${s3BaseURL}/${url.tif_path}`,
                    bands: [1, 2, 3],
                    nodata: 0,  // Adjust if needed
                    transparent: true
                }]
            }),
            // visible: index === 0,  // Only first visible by default
            opacity: 0.8,
            title: `Visual Layer ${index + 1}`
        }));
        // Thermal ortho as separate layers
        const thermalLayers = thermal_ortho.map((url, index) => new ol.layer.WebGLTile({
            source: new ol.source.GeoTIFF({
                sources: [{
                    url: `${s3BaseURL}/${url.tif_path}`,
                    bands: [1, 2, 3],  // Adjust if your TIFFs are not RGB
                    nodata: 255
                }]
            }),
            visible: false,  // Show only first by default
            opacity: 1,
            title: `Thermal Layer ${index + 1}`
        }));

        const vectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector({ features: features }),
            style: function (feature) {
                const defect = feature.values_.Anomaly;
                const baseColor = fault_colors[feature.values_.Anomaly] || '#999999';
                const fillColor = hexToRgba(baseColor, 1);

                return new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 6,
                        fill: new ol.style.Fill({ color: baseColor }),
                        stroke: new ol.style.Stroke({
                            color: '#fff',
                            width: 1
                        })
                    }),
                    stroke: new ol.style.Stroke({
                        color: baseColor,
                        width: 2
                    }),
                    fill: new ol.style.Fill({
                        color: fillColor
                    })
                });
            }
        });

        console.log("Initializing map with layers:", {
            baseLayer: baseLayer,
            visualLayersCount: visualLayers.length,
            thermalLayersCount: thermalLayers.length,
            vectorFeatures: features.length,
            mapTarget: document.getElementById('map')
        });
        
        // Make map globally accessible
        window.map = new ol.Map({
            target: 'map',
            view: view,
            layers: [baseLayer, ...visualLayers, ...thermalLayers, vectorLayer],
            controls:
            [
                new ol.control.Zoom(),
                new ol.control.Attribution(),
                new ol.control.FullScreen()
            ]
        });
        
        console.log("Map initialized:", window.map);
        
        // Set a local reference for the current context
        const map = window.map;

        window.map.on('click', function (event) {
            const map = window.map; // Ensure local access to the map
            map.forEachFeatureAtPixel(event.pixel, function (feature) {
                console.log(feature.values_);
                handleAnomalyClickMap(feature.values_)

            });
        });

        const btnVisual = document.getElementById('btnVisual');
        const btnThermal = document.getElementById('btnThermal');

        // Add variable to track vector layer state
        let vectorLayerWasVisible = true;

        btnVisual.addEventListener('click', () => {
            const button = document.querySelector('.toggle-geojson');

            // visualLayer.setVisible(true);
            // thermalLayer.setVisible(false);
            visualLayers.forEach((layer, i) => layer.setVisible(i === 0));  // Show only first by default

            // thermalLayers.forEach((layer, i) => layer.setVisible(i !== i));  // Show only first by default
            thermalLayers.forEach((layer) => layer.setVisible(false));


            // Restore vector layer visibility based on previous state
            vectorLayer.setVisible(vectorLayerWasVisible);

            // Update toggle button state
            if (vectorLayerWasVisible) {
                button.classList.add('active');
                button.textContent = 'Hide Anamoly';
                button.setAttribute('data-state', 'visible');
            } else {
                button.classList.remove('active');
                button.textContent = 'Show Anamoly';
                button.setAttribute('data-state', 'hidden');
            }

            // Enable the toggle button
            button.style.pointerEvents = 'auto';
            button.style.opacity = '1';

            btnVisual.classList.add('active');
            btnThermal.classList.remove('active');
        });

        btnThermal.addEventListener('click', () => {
            // Store current vector layer visibility state before hiding
            vectorLayerWasVisible = vectorLayer.getVisible();

            // thermalLayer.setVisible(true);
            thermalLayers.forEach((layer, i) => layer.setVisible(i === 0));  // Show only first by default

            // visualLayer.setVisible(false);
            // visualLayers.forEach((layer, i) => layer.setVisible(i !== i));  // Show only first by default
            visualLayers.forEach((layer) => layer.setVisible(false));

            vectorLayer.setVisible(false);

            // Disable the toggle button
            const button = document.querySelector('.toggle-geojson');
            button.style.pointerEvents = 'none';
            button.style.opacity = '0.5';
            button.classList.remove('active');
            button.textContent = 'Show Anamoly';
            button.setAttribute('data-state', 'hidden');

            btnThermal.classList.add('active');
            btnVisual.classList.remove('active');
        });

        function hexToRgba(hex, alpha) {
            const bigint = parseInt(hex.replace('#', ''), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgba(${r},${g},${b},${alpha})`;
        }

        function downloadImage(url, filename) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const blobUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(blobUrl);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('Error downloading image:', error);
                    alert('Failed to download image. Please try again.');
                });
        }

        // Navigation functions are now defined in audit_detail.js
                        // This function is now defined in audit_detail.js

        // User dropdown functionality
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdown');
            const userBtn = document.querySelector('.user-btn');
            
            if (userBtn && dropdown && !userBtn.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Fullscreen image functionality
        function openFullscreen(imageSrc) {
            const overlay = document.getElementById('fullscreenOverlay');
            const fullscreenImg = document.getElementById('fullscreenImage');
            
            fullscreenImg.src = imageSrc;
            overlay.classList.add('active');
            
            // Prevent scrolling on the body
            document.body.style.overflow = 'hidden';
            
            // Add ESC key listener to close
            document.addEventListener('keydown', handleEscKey);
        }
        
        function closeFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.remove('active');
            
            // Re-enable scrolling
            document.body.style.overflow = '';
            
            // Remove ESC key listener
            document.removeEventListener('keydown', handleEscKey);
        }
        
        function handleEscKey(event) {
            if (event.key === 'Escape') {
                closeFullscreen();
            }
        }
        
        // Close fullscreen when clicking outside the image
        document.getElementById('fullscreenOverlay').addEventListener('click', function(event) {
            if (event.target === this) {
                closeFullscreen();
            }
        });

</script>

<!-- Load external JS at the end of the body for better performance -->
<script src="{{ url_for('static', filename='audit_detail.js') }}?v={{ now }}"></script>

</body>

</html>