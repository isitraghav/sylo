<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ audit.name }} - Audit Details</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/ol@7.4.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/geotiff@1.0.0-beta.7/dist/geotiff.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol-geotiff@3.1.0/dist/ol-geotiff.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.4.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol/ol.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2e7d32;
            --secondary-color: #F97316;
            --accent-color: #06B6D4;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --error-color: #EF4444;
            --background-color: #F8FAFC;
            --surface-color: #FFFFFF;
            --text-color: #1E293B;
            --text-secondary: #64748B;
            --border-color: #E2E8F0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .main-app {
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 150px;
            /* background: var(--primary-color); */
            border-right: 1px solid var(--border-color);
            /* padding: 20px 0; */
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }




        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar.collapsed .sidebar-logo h2,
        .sidebar.collapsed .sidebar-menu span {
            display: none;
        }

        .sidebar.collapsed .sidebar-menu a {
            padding: 12px;
            justify-content: center;
        }

        .sidebar.collapsed .sidebar-menu svg {
            margin-right: 0;
        }

        .toggle-sidebar {
            position: absolute;
            right: -12px;
            top: 20px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-sidebar:hover {
            background: var(--background-color);
        }


        .sidebar-logo {
            border-bottom: 1px solid var(--border-color);
            /* margin-bottom: 10px; */
            text-align: center;
        }

        .sidebar-logo img {
            width: 100%;
            height: auto;
            max-width: 150px;
            display: block;
            margin: 0 auto;
        }

        .sidebar-logo h2 {
            color: var(--primary-color);
            font-size: 20px;
            font-weight: 700;
        }


        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: black;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: var(--primary-color);
            color: white;
            border-right: 3px solid var(--primary-color);
        }

        .sidebar-menu svg {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            min-width: 20px;
            min-height: 20px;
            flex-shrink: 0;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 150px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 60px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #F8FAFC;
            padding: 16px 30px;
            position: fixed;
            top: 0;
            left: 150px;
            right: 0;
            z-index: 50;
            border-bottom: 1px solid var(--border-color);
            height: 64px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .header-right-buttons {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .back-button {
            background-color: #2e7d32;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .back-button:hover {
            background-color: var(--border-color);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-size: 14px;
            padding: 4px 0;
        }

        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .header-center {
            display: flex; 
            align-items: center; 
            gap: 6px;
            background-color: #F1F5F9;
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .top-btn {
            padding: 6px 14px; 
            background: transparent; 
            border: none;
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600;
            color: #334155; 
            cursor: pointer;
            transition: all 0.2s;
        }

        .top-btn.active { 
            background: var(--primary-color); 
            color: white; 
        }

        .top-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .user-dropdown {
            position: relative;
        }

        .user-btn {
            background: var(--background-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-btn:hover {
            background: var(--border-color);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: none;
            min-width: 150px;
            z-index: 1000;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 15px;
            text-align: left;
            color: var(--text-color);
            text-decoration: none;
            border: none;
            background: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown-item:hover {
            background: var(--background-color);
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #0284C7;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--primary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #CBD5E1;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 85px 30px 30px;
            overflow-y: auto;
        }

        /* Audit Header */
        .audit-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--warning-color));
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .audit-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(25px, -25px);
        }

        .audit-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .audit-subtitle {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .audit-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .meta-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .meta-label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .meta-value {
            font-size: 18px;
            font-weight: 600;
        }

        /* Top Menu Bar */
        .top-menu {
            background: var(--surface-color);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .menu-nav {
            display: flex;
            gap: 0;
        }

        .menu-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .menu-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .menu-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Content Sections */
        .content-section {
            background: var(--surface-color);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .section-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* .section-content {
            padding: 30px;
        } */

        /* Filters */
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0px;
            margin-bottom:5px;
            padding: 0 12px;
        }

        .filter-label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
           /* min-width: 200px; */
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--background-color);
            font-weight: 600;
            color: var(--text-color);
        }

        .data-table tr:hover {
            background: var(--background-color);
        }

        /* Anomaly Cards */
        .anomaly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .anomaly-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .anomaly-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .anomaly-type {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .anomaly-severity {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .severity-high {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        .severity-medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .severity-low {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .anomaly-details {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .anomaly-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-toggle {
            position: relative;
            width: 50px;
            height: 24px;
            background: var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .status-toggle.resolved {
            background: var(--success-color);
        }

        .status-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .status-toggle.resolved::after {
            transform: translateX(26px);
        }

        .status-label {
            font-size: 14px;
            font-weight: 500;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        .chart-container {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .chart-placeholder {
            width: 100%;
            height: 250px;
            background: var(--background-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
                z-index: 100;
            }

            .main-content {
                margin-left: 0;
            }
            
            .header {
                left: 0;
                padding: 10px 15px;
                flex-wrap: wrap;
                height: auto;
            }
            
            .header-center {
                margin: 10px 0;
                width: 100%;
                justify-content: center;
                order: 1;
            }
            
            .breadcrumb {
                width: 100%;
                margin-bottom: 10px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .back-button {
                font-size: 12px;
                padding: 6px 10px;
            }

            .audit-meta {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .filter-select {
                min-width: auto;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .anomaly-grid {
                grid-template-columns: 1fr;
            }
        }

        .left-panel {
            width: 200px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 14px;
        }

        .tab.active {
            border-bottom-color: #4285f4;
            color: #4285f4;
        }

        .search-bar {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .anomalies-btn {
            background: #ea4335;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 8px;
            cursor: pointer;
            font-size: 13px;
            width: 100%;
        }

        .results-count {
            padding: 8px 12px;
            font-size: 12px;
            color: #666;
            border-bottom: 1px solid #e0e0e0;
        }

        .inspection-list {
            flex: 1;
            overflow-y: auto;
        }

        .inspection-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s ease;
        }

        .inspection-item:hover {
            background: #f8f9fa;
        }

        .inspection-item.selected {
            background: #e3f2fd;
            border-left: 3px solid #4285f4;
        }

        .inspection-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .inspection-subtitle {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-red {
            background: #ea4335;
        }

        .status-orange {
            background: #ff9800;
        }

        .status-green {
            background: #34a853;
        }

        .map-panel {
            flex: 1;
            position: relative;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin: 0 15px;
            overflow: hidden;
        }

        .map-container {
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 600"><rect fill="%23d4b896" width="1000" height="600"/><g fill="%23c4a886"><rect x="0" y="0" width="50" height="30"/><rect x="100" y="50" width="80" height="40"/><rect x="200" y="100" width="60" height="35"/><rect x="300" y="20" width="70" height="45"/></g></svg>') center/cover;
            position: relative;
            border-bottom: 1px solid #e0e0e0;
        }

        .map-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: row;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .map-btn {
            min-width: 90px;
            height: 36px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            padding: 0 16px;
        }

        .map-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            color: #0f172a;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .map-btn.active {
            background: var(--primary-color);
            color: #0f172a;
            border-color: #cbd5e1;
            font-weight: 600;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .fullscreen-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: white;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        /* .anomaly-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ea4335;
            border-radius: 50%;
            cursor: pointer;
        } */

        .heatmap-container {
            height: 25%;
            display: flex;
            padding: 10px;
            gap: 10px;
        }

        .heatmap {
            flex: 1;
            background: linear-gradient(45deg, #ff4444, #ffaa00, #ffff00);
            border-radius: 4px;
            position: relative;
        }

        .heatmap-label {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 2px;
        }

        .right-panel {
            width: 300px;
            background: white;
            border-left: 1px solid #e0e0e0;
            padding: 5px;
            overflow-y: auto;
        }

        .date-selector {
            background: var(--primary-color);
            padding: 6px 10px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 13px;
            text-align: center;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 26px;
            font-weight: 600;
            color:var(--primary-color);
        }

        .stat-label {
            font-size: 16px;
            color: #666;
            margin-top: 2px;
        }

        .detail-section {
            margin-bottom: 15px;
        }

        .detail-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 14px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 13px;
        }

        .detail-label {
            color: #666;
        }

        .detail-value {
            font-weight: 500;
        }

        .download-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            z-index: 10;
        }

        .download-btn:hover {
            background: white;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .download-btn svg {
            width: 16px;
            height: 16px;
            color: #0750ff;
        }

        .container {
            display: flex;
            height: calc(124vh - 300px);
            /* margin: 20px 0; */
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* full size */
        .ctl {
            padding: 2px 10px 2px 10px;
            background: white;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            text-align: right;
        }

        .title {
            font-size: 18pt;
            font-weight: bold;
        }

        .src {
            font-size: 10pt;
        }

        .selected-data-section {
            width: 100%;
            height: 75%;
            display: flex;
            flex-direction: column;
        }

        .selected-data-section-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .upper-section {
            width: 100%;
            height: 30% !important;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .lower-section {
            flex: 1;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .detail-title {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loader-container {
            text-align: center;
            padding: 40px;
        }

        .loader-text {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        /* Active/Selected state */
        .inspection-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }

        .map-controls {
            display: inline-flex;
            gap: 15px;
            background: #fff;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        /* .map-btn {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      background: #e0e0e0;
      color: #444;
      cursor: pointer;
      opacity: 0.6;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    } */

        .map-btn:hover {
            transform: scale(1.05);
            opacity: 0.85;
        }

        .map-btn.active {
            background: var(--primary-color);
            color: #fff;
            opacity: 1;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.6);
        }

        .ol-full-screen {
            top: 0.5em;
            right: 0.5em;
        }

        /* When in fullscreen */
        #map:fullscreen {
            height: 100% !important;
            background-color: #f0f0f0 !important;
        }

        #map:-webkit-full-screen {
            height: 100% !important;
            background-color: #f0f0f0 !important;
        }

        .map-btn.toggle-geojson {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .map-btn.toggle-geojson::before {
            content: '‚úì';
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #e2e8f0;
            border-radius: 4px;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            color: white;
            transition: all 0.2s ease;
        }

        .map-btn.toggle-geojson:hover {
            background: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .map-btn.toggle-geojson.active {
            background: #f1f5f9;
            color: #0f172a;
            border-color: #cbd5e1;
        }

        .map-btn.toggle-geojson.active::before {
            background: var(--primary-color);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* gap: 8px; */
            max-width: 300px;
            margin: auto;
        }

        .grid-item {
            text-align: center;
            padding: 6px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .label {
            font-size: 14px;
            /* font-weight: bold; */
        }

        .value {
            font-size: 16px;
            /* font-weight: bold; */
        }

        #button_check {
            padding: 20px;
        }

        /* Add these new styles for the boxed items */
        .detail-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .detail-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-color: #cbd5e1;
        }

        .detail-box .detail-label {
            display: block;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .detail-box .detail-value {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
        }

        .detail-boxes-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* gap: 12px; */
            /* margin: 20px 0; */
        }

        .detail-box.full-width {
            grid-column: 1 / -1;
        }

        .button-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .action-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .resolve-btn {
            background: var(--primary-color);
            color: white;
        }

        .pending-btn {
            background: linear-gradient(to right, #f97316, #fb923c);
            color: white;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .image-container {
            position: relative;
            width: 100%;
            height: 30%;
            margin-bottom: 15px;
        }

        .upper-section {
            width: 100%;
            height: 100% !important;
            object-fit: cover;
            border-radius: 8px;
        }

        .download-btn {
            position: absolute;
            top: 1px;
            right: 1px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .download-btn:hover {
            background: white;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .download-btn svg {
            width: 20px;
            height: 20px;
            color: #0750ff;
        }

    </style>
</head>

<body>
<div class="main-app">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="toggle-sidebar" onclick="toggleSidebar()">
            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </div>
        <div class="sidebar-logo">

            <img src="{{ url_for('static', filename='images/logo/logo1.png') }}" alt="Solar Plant Manager Logo">
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="/homepage"  title="Home">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                        </path>
                    </svg>
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="#" class="active" title="Thermography">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                        </path>
                    </svg>
                    <span>Thermography</span>
                </a>
            </li>
            <li>
                <a href="#"  title="IV Curve Testing">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"

                         stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <path d="M3 20 V4 H21"/> <!-- Axes -->
                        <path d="M3 18 C6 14, 12 8, 21 4"/> <!-- IV Curve -->
                    </svg>
                    <span>IV Curve Testing</span>
                </a>
            </li>

            <li>
                <a href="#" title="EL Testing">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"

                         stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <!-- Simple glowing cell icon -->
                        <rect x="4" y="4" width="16" height="16" rx="2" ry="2"/>
                        <path d="M4 10h16M4 14h16"/>
                        <path d="M10 4v16"/>
                    </svg>
                    <span>EL Testing</span>
                </a>
            </li>
            <li>
                <a href="#" title="Transmission Line">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"

                         stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <!-- Transmission pole with cross arms and wires -->
                        <path d="M12 3v18"/> <!-- Vertical pole -->
                        <path d="M6 6h12M4 10h16M6 14h12"/> <!-- Cross arms -->
                        <path d="M6 6l-2 4M18 6l2 4M6 14l-2-4M18 14l2-4"/> <!-- Wires -->
                    </svg>
                    <span>Transmission Line</span>
                </a>
            </li>
            <li>
                <a href="#" title="Data">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4">
                        </path>
                    </svg>
                    <span>Data</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="breadcrumb">
                <a href="/homepage">Plants</a> /
                <a href="/plant_detail/{{ plant.id }}">{{ plant.name }}</a> /
                <span>{{ audit.name }}</span> (Audit Detail)
            </div>
            <div class="header-actions">
                <div class="header-center">
                    <button class="top-btn" onclick="openOverview()">Overview</button>
                    <button class="top-btn active">Anomalies</button>
                    <button class="top-btn" onclick="openSiteDetails()">Site Details</button>
                    <button class="top-btn">Report</button>
                </div>
                <div class="user-dropdown">
                    <button class="user-btn" onclick="toggleUserDropdown()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span>{{ session.user_name or 'User' }}</span>
                    </button>
                    <div class="dropdown-menu" id="userDropdown">
                        <a href="/logout" class="dropdown-item">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Logout
                        </a>
                    </div>
                </div>
                    <button class="back-button" onclick="window.location.href='/homepage'">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back to Plants
                    </button>
                </div>
            </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Audit Header -->
            <!--                <div class="audit-header">-->
            <!--                    <h1 class="audit-title">{{ audit.name }}</h1>-->
            <!--                    <p class="audit-subtitle">{{ plant.name }} ‚Ä¢ Project Code: {{ audit.project_code }}</p>-->

            <!--                    <div class="audit-meta">-->
            <!--                        <div class="meta-item">-->
            <!--                            <div class="meta-label">Start Date</div>-->
            <!--                            <div class="meta-value">{{ audit.start_date }}</div>-->
            <!--                        </div>-->
            <!--                        <div class="meta-item">-->
            <!--                            <div class="meta-label">Completion Date</div>-->
            <!--                            <div class="meta-value">{{ audit.completion_date }}</div>-->
            <!--                        </div>-->
            <!--                        <div class="meta-item">-->
            <!--                            <div class="meta-label">Duration</div>-->
            <!--                        </div>-->
            <!--                        <div class="meta-item">-->
            <!--                            <div class="meta-label">Status</div>-->
            <!--                            <div class="meta-value">{{ audit.status.title() }}</div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                </div>-->

            <!-- Top Menu -->
            <!-- <div class="top-menu">
                <div class="menu-nav">
                    <button class="menu-btn active" onclick="showSection('drone')" id="droneBtn">
                        Drone Thermography
                    </button>
                    <button class="menu-btn" onclick="showSection('iv')" id="ivBtn" disabled>
                        IV Testing
                    </button>
                    <button class="menu-btn" onclick="showSection('el')" id="elBtn" disabled>
                        EL Testing
                    </button>
                    <button class="menu-btn" onclick="showSection('transmission')" id="transmissionBtn" disabled>
                        Transmission Line
                    </button>
                </div>
            </div> -->

            <!-- Drone Thermography Section -->
            <div id="droneSection" class="content-section">
                <!-- <div class="section-header">
                    <div class="section-title">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                        Drone Thermography Analysis
                    </div>
                </div> -->

                <div class="section-content">


                    <div class="container">


                        <!-- Left Panel -->
                        <div class="left-panel">
                            <div class="filter-group">
                                <label class="filter-label">Block Filter </label>
                                <select class="filter-select" id="blockFilter" onchange="filterData()">
                                    <option value="">All Blocks</option>

                                    {% for filter in block_filters %}
                                    <option value="{{filter}}">{{filter}}</option>

                                    {% endfor %}

                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Anomaly Filter </label>
                                <select class="filter-select" id="anomalyFilter" onchange="filterData()">
                                    <option value="">All Anomalies</option>
                                    {% for a_filter in anomaly_filter %}
                                    <option value="{{a_filter}}">{{a_filter}}</option>

                                    {% endfor %}

                                </select>
                            </div>
                            <div class="filter-group" style="display:none;">
                                <label class="filter-label">Anomaly Status </label>
                                <select class="filter-select" id="anomalyStatusFilter" onchange="filterData()">
                                    <option value="">All Anomalies</option>
                                    <option value="pending">Pending</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                            </div>
                            <div class="search-bar">
                                <input type="text" class="search-input" placeholder="Search...">
                                <button class="anomalies-btn">üîç Anomalies</button>

                            </div>

                            <div class="results-count">
                                Showing <strong> {{ anomalies|length }} </strong> anomalies
                            </div>

                            <div class="inspection-list">

                                {% for anomaly in anomalies %}
                                <div class="inspection-item">
                                    <div class="inspection-title" data-anomaly='{{ anomaly|tojson|safe }}'
                                         onclick="handleAnomalyClick(this)">
                                        #{{ anomaly.properties['Image name'].split('.')[0] }} ({{
                                        anomaly.properties.ID }}{% if anomaly.properties.inverter %}, Inverter-{{
                                        anomaly.properties.inverter }}{% endif %}{% if anomaly.properties.scb %},
                                        SCB-{{ anomaly.properties.scb }}{% endif %}{% if anomaly.properties.String
                                        %}, String-{{ anomaly.properties.String }}{% endif %}{% if
                                        anomaly.properties.panel %}, Module-{{ anomaly.properties.panel }}{% endif
                                        %})
                                    </div>
                                    <div class="inspection-subtitle">
                                        <span class="status-dot status-red"></span>{{ anomaly.properties.Anomaly }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Map Panel -->
                        <div class="map-panel">
                            <!-- <div class="map-container"> -->

                            <div id="map">

                                <div class="map-controls">
                                    <button class="map-btn active" id="btnVisual">Visual</button>
                                    <button class="map-btn " id="btnThermal">Thermal</button>

                                    </button>
                                </div>
                            </div>

                            <button class="map-btn toggle-geojson" onclick="toggleGeojson()">
                                Hide Anamoly
                            </button>

                            <!-- </div> -->


                        </div>

                        <!-- Right Panel -->
                        <div class="right-panel">

                            <div id="divATop" class="main_right">
                                <div class="date-selector">{{ audit.name }}</div>

                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div class="stat-number">{{ anomalies|length }}</div>
                                        <div class="stat-label">Anomalies</div>
                                    </div>
                                    <div class="stat-item">

                                        <div class="stat-number">{{ plant.total_modules_inspected }}</div>
                                        <div class="stat-label">Modules Inspected</div>

                                    </div>
                                </div>


                                <!-- <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Healthy</span>
                                        <div class="detail-value">{{ plant.total_modules_inspected -
                                            anomalies|length }}</div>

                                    </div>
                                </div> -->
                                <!--
                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Client</span>
                                        <div class="detail-value">{{ plant.name }}</div>

                                    </div>
                                </div> -->

                                <!-- <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">AC Capacity</span>
                                        <span class="detail-value">{{ plant.ac_capacity }}</span>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">DC Capacity</span>
                                        <span class="detail-value">{{ plant.dc_capacity }}</span>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Start Date</span>
                                        <span class="detail-value">{{audit.start_date}}</span>
                                    </div>
                                </div>
                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Completion Date</span>
                                        <span class="detail-value">{{audit.completion_date}}</span>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Weather</span>
                                        <span class="detail-value">Clear, Sunny</span>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Location</span>
                                        <span class="detail-value">Khetakhali, Gujarat 364001</span>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-item">
                                        <span class="detail-label">Plant Coordinates</span>
                                        <span class="detail-value">{{ plant.latitude }}, {{ plant.longitude
                                            }}</span>

                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                    </div>
                                </div> -->
                                <div class="grid-container">

                                    {% for anomaly, count in anomaly_count.items() %}
                                    <div class="grid-item">
                                        <div class="value"
                                             style="color: {{ fault_colors.get(anomaly, '#999999') }};">{{ count }}
                                        </div>
                                        <div class="label"
                                             style="color: {{ fault_colors.get(anomaly, '#999999') }};">{{ anomaly }}
                                        </div>
                                    </div>
                                    {% endfor %}

                                    <!-- Add additional rows similarly -->
                                </div>


                            </div>

                            <div id="divABottom" class="selected-data-section hidden">
                                <div class="selected-data-section-content" id="anomalyDetails">
                                    <!-- <img class="upper-section"
                                        src="{{s3_base_path}}"
                                        alt="Data Check" /> -->


                                    <!-- <div id="anomalyDetails" class="lower-section">

                                    </div> -->
                                </div>
                            </div>


                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- Other Sections (Placeholder for future implementation) -->
    <div id="ivSection" class="content-section hidden">
        <div class="section-header">
            <div class="section-title">IV Testing Analysis</div>
        </div>
        <div class="section-content">
            <div class="empty-state">
                <h3>IV Testing Coming Soon</h3>
                <p>This feature will be enabled after the website goes live.</p>
            </div>
        </div>
    </div>

    <div id="elSection" class="content-section hidden">
        <div class="section-header">
            <div class="section-title">EL Testing Analysis</div>
        </div>
        <div class="section-content">
            <div class="empty-state">
                <h3>EL Testing Coming Soon</h3>
                <p>This feature will be enabled after the website goes live.</p>
            </div>
        </div>
    </div>

    <div id="transmissionSection" class="content-section hidden">
        <div class="section-header">
            <div class="section-title">Transmission Line Analysis</div>
        </div>
        <div class="section-content">
            <div class="empty-state">
                <h3>Transmission Line Testing Coming Soon</h3>
                <p>This feature will be enabled after the website goes live.</p>
            </div>
        </div>
    </div>
</div>
</div>
</div>


<script>
        // Add this at the beginning of your script section
        document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.querySelector('.toggle-sidebar svg');

            if (sidebar && mainContent && toggleBtn) {
                // Collapse sidebar by default
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');

                // Update toggle button icon
                toggleBtn.style.transform = 'rotate(180deg)';
            }
        });

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const header = document.querySelector('.header');
            const toggleBtn = document.querySelector('.toggle-sidebar svg');

            if (sidebar && mainContent && toggleBtn) {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
                
                // Update header position when sidebar is collapsed/expanded
                if (sidebar.classList.contains('collapsed')) {
                    if (header) {
                        header.style.left = '60px';
                    }
                } else {
                    if (header) {
                        header.style.left = '150px';
                    }
                }

                // Rotate the arrow icon
                if (sidebar.classList.contains('collapsed')) {
                    toggleBtn.style.transform = 'rotate(180deg)';
                } else {
                    toggleBtn.style.transform = 'rotate(0deg)';
                }
            }
        }

        // Section switching functionality
        function showSection(sectionId) {
            const sections = ['map-section', 'anomalies-section', 'reports-section'];
            const section = document.getElementById(sectionId);

            if (!section) return; // Exit if section doesn't exist

            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('active');
                }
            });

            section.classList.add('active');
        }

        // Initialize sections
        document.addEventListener('DOMContentLoaded', function () {
            // Show map section by default
            const mapSection = document.getElementById('map-section');
            if (mapSection) {
                mapSection.classList.add('active');
            }

            // Add click handlers for section buttons
            const sectionButtons = document.querySelectorAll('.section-btn');
            sectionButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        showSection(sectionId);
                    }
                });
            });
        });


        function filterAnomalyShowVector(anomalyFilter) {
            //
            const filteredRawFeatures = anomalyFilter
            const feature = {
                "Cell": "#FF0000",
                "Multi Cell": "#FFA500",
                "Bypass Diode": "#9C27B0",
                "Short Circuit": "#000000",
                "String Offline": "#FF1A94",
                "Module Power Mismatch": "#65E667",
                "Shading": "#E77148",
                "Plant Found": "#2E7D32",
                "Other": "#00BFFF",
                "Junction Box": "#BFC494",
                "Physical Damage": "#C2185B",
                "Module Missing": "#FFFFFF",
                "Module Offline": "#FF1493"
            };


            const format = new ol.format.GeoJSON();

            // Filter raw GeoJSON first (optional, if your original is geojsonData)
            // const filteredRawFeatures = geojsonData.features.filter(f => {
            //     return !anomalyFilter || f.properties.Anomaly === anomalyFilter;
            // });

            // Create a FeatureCollection
            const filteredGeoJSON = {
                type: "FeatureCollection",
                features: filteredRawFeatures
            };

            // ‚úÖ Convert to ol.Feature[]
            const filteredFeatures = format.readFeatures(filteredGeoJSON, {
                dataProjection: 'EPSG:4326',
                featureProjection: 'EPSG:4326'
            });

            // ‚úÖ Add to map
            vectorSource.clear();

            filteredFeatures.forEach(feature => {
                const anomaly = feature.get('Anomaly'); // works if `properties` were properly parsed
                const color = fault_colors[anomaly] || '#999999';

                feature.setStyle(new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 6,
                        fill: new ol.style.Fill({ color }),
                        stroke: new ol.style.Stroke({ color: '#fff', width: 1 })
                    })
                }));

                vectorSource.addFeature(feature);
            });

        };




        // Filter functionality
        function filterData() {
            try {
                const blockFilter = document.getElementById('blockFilter').value;
                const anomalyFilter = document.getElementById('anomalyFilter').value;
                const anomalyStatusFilter = document.getElementById('anomalyStatusFilter').value;
                let audit_id_value = "{{ audit._id }}"

                // Get all inspection items
                const inspectionItems = document.querySelectorAll('.inspection-item');

                console.log("--audit_id_value", audit_id_value)

                let visibleCount = 0;

                // Create a new source for the filtered features
                const newSource = new ol.source.Vector();

                // Get all features from the original source
                // const allFeatures = vectorLayer.getSource().getFeatures();

                const formData = new FormData();
                formData.append('block', blockFilter);
                formData.append('an', anomalyFilter);
 formData.append('anStatus', anomalyStatusFilter);

                // Create and configure XMLHttpRequest
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `/api/get_geojson/${audit_id_value}`, true);

                // Set up event handlers
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        try {
                            const newGeoJSONData = JSON.parse(xhr.responseText);
                            const resultsCount = document.querySelector('.results-count');
                            if (resultsCount) {
                                resultsCount.innerHTML = `Showing <strong>${newGeoJSONData.length}</strong> anomalies`;
                            }
                            visibleCount = newGeoJSONData.length
                            // Update the vector source with new features
                            const format = new ol.format.GeoJSON();
                            const newFeatures = format.readFeatures({
                                type: "FeatureCollection",
                                features: newGeoJSONData
                            }, {
                                dataProjection: 'EPSG:4326',
                                featureProjection: 'EPSG:4326'
                            });

                            // Clear existing features and add new ones
                            const source = vectorLayer.getSource();

                            vectorLayer.getSource().clear();
                            vectorLayer.getSource().addFeatures(newFeatures);

                            // Update the global geojsonData variable
                            geojsonData = {
                                type: "FeatureCollection",
                                features: newGeoJSONData
                            };
                            console.log("coming here", newGeoJSONData)
                            // Auto zoom to the extent of the new features
                            const extent = source.getExtent();
                            if (extent && extent.every(Number.isFinite)) {
                                console.log("---log")
                                map.getView().fit(extent, {
                                    padding: [20, 20, 20, 20],
                                    duration: 1000
                                });
                            }


                            // Show success message
                            // alert('GeoJSON data refreshed successfully!');
                        } catch (error) {
                            console.error('Error parsing response:', error);
                            alert('Failed to parse response data. Please try again.');
                        }
                    } else {
                        alert('Failed to refresh data. Server returned status: ' + xhr.status);
                    }
                };

                xhr.onerror = function () {
                    console.error('Request failed');
                    alert('Failed to refresh data. Please check your connection and try again.');
                };

                // Send the request
                xhr.send(formData);


                let anyFilterData = []
                // Filter and add features to the new source
                // allFeatures.forEach(feature => {
                //     const properties = feature.getProperties();
                //     const block = properties.Block;
                //     const anomalyType = properties.Anomaly;
                //     const blockMatch = !blockFilter || block === blockFilter.toString();
                //     const anomalyMatch = !anomalyFilter || anomalyType === anomalyFilter;

                //     if (blockMatch && anomalyMatch) {
                //         console.log("---anomalyMatch", properties)
                //         anyFilterData.push(properties)
                //         const color = fault_colors[anomalyType] || '#999999';

                //         // Create a new feature with the same properties
                //         const newFeature = new ol.Feature({
                //             geometry: feature.getGeometry(),
                //             ...properties
                //         });

                //         // Set the style for the new feature
                //         newFeature.setStyle(new ol.style.Style({
                //             image: new ol.style.Circle({
                //                 radius: 6,
                //                 fill: new ol.style.Fill({
                //                     color: color
                //                 }),
                //                 stroke: new ol.style.Stroke({
                //                     color: '#fff',
                //                     width: 1
                //                 })
                //             })
                //         }));

                //         // Add the feature to the new source
                //         newSource.addFeature(newFeature);
                //         visibleCount++;
                //     }
                // });
                // filterAnomalyShowVector(anyFilterData)

                // console.log("---newSource", newSource)

                // Update the vector layer with the new source
                // vectorLayer.setSource(newSource);


                // const filtered = allFeatures.filter(f => selectedDefects.includes(f.get('Anomaly')));
                // vectorSource.clear();  // Remove old features
                // vectorSource.addFeatures(filtered);  // Add filtered ones

                inspectionItems.forEach(item => {
                    try {
                        const anomalyData = JSON.parse(item.querySelector('.inspection-title').getAttribute('data-anomaly'));
                        const block = anomalyData.properties.Block;
                        const anomalyType = anomalyData.properties.Anomaly;

                        // Check if item matches both filters
                        const blockMatch = !blockFilter || block === blockFilter.toString();
                        const anomalyMatch = !anomalyFilter || anomalyType === anomalyFilter;

                        // Show/hide item based on filter matches
                        if (blockMatch && anomalyMatch) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    } catch (parseError) {
                        console.error('Error parsing anomaly data:', parseError);
                        // Hide items with invalid data
                        item.style.display = 'none';
                    }
                });

                // Update the results count
                // const resultsCount = document.querySelector('.results-count');
                // if (resultsCount) {
                //     resultsCount.innerHTML = `Showing <strong>${visibleCount}</strong> anomalies`;
                // }

                // Force a redraw of the vector layer
                // vectorLayer.changed();


            } catch (err) {
                console.error('Error in filterData:', err);
            }
        }

        // Toggle anomaly status
        async function toggleAnomalyStatus(auditId, anomalyId, toggleElement, statusValue) {
            const isResolved = toggleElement.classList.contains('resolved');

            const newStatus = statusValue//isResolved ? 'pending' : 'resolved';
            try {
                const response = await fetch(`/api/anomalies/${auditId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'anomaly_id': anomalyId,
                        status: newStatus
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Update UI
                    // toggleElement.classList.toggle(statusValue);
                    // const statusLabel = toggleElement.nextElementSibling;
                    // statusLabel.textContent = newStatus === 'resolved' ? 'Resolved' : 'Pending';
                    // alert(result.message);
                    // Create new button HTML based on new status
                    //             const oppositeStatus = newStatus === 'resolved' ? 'pending' : 'resolved';
                    //             const newButtonHTML = `
                    // <button class="action-button ${oppositeStatus}-btn" onclick="toggleAnomalyStatus('${auditId}', '${anomalyId}', this, '${oppositeStatus}')">
                    //     ${oppositeStatus.charAt(0).toUpperCase() + oppositeStatus.slice(1)}
                    // </button>`;

                    //             // Replace the entire container's innerHTML
                    //             toggleElement.parentElement.innerHTML = newButtonHTML;

                    //             alert(result.message);
                    const oppositeStatus = newStatus === 'resolved' ? 'pending' : 'resolved';

                    const newButtonContainerHTML = `
        <div class="button-container">
            <button class="action-button ${oppositeStatus}-btn" onclick="toggleAnomalyStatus('${auditId}', '${anomalyId}', this, '${oppositeStatus}')">
                ${oppositeStatus.charAt(0).toUpperCase() + oppositeStatus.slice(1)}
            </button>
        </div>`;

                    // Replace the full button container
                    const buttonContainer = toggleElement.closest('.button-container');
                    buttonContainer.outerHTML = newButtonContainerHTML;

                    alert(result.message);

                } else {
                    alert('Failed to update status: ' + result.message);
                }
                // location.reload();
            } catch (error) {
                console.error('Error updating anomaly status:', error);
                alert('Error updating status. Please try again.');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            // Show drone section by default
            showSection('drone');

            // Select the first inspection item by default
            const inspectionItems = document.querySelectorAll('.inspection-item');
            if (inspectionItems && inspectionItems.length > 0) {
                const firstItem = inspectionItems[0];
                const titleElement = firstItem.querySelector('.inspection-title');
                if (titleElement) {
                    // Trigger click on the first inspection item
                    handleAnomalyClick(titleElement);
                }
            }
            
            // // Add click event listeners to inspection items
            // const inspectionItems = document.querySelectorAll('.inspection-item');
            // console.log("---inspectionItems",inspectionItems)
            // inspectionItems.forEach(item => {
            //     item.addEventListener('click', handleInspectionItemClick);
            // });
        });

        // Function to handle inspection item clicks
        function handleInspectionItemClick(event) {
            // Remove selected class from all items
            document.querySelectorAll('.inspection-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selected class to clicked item
            this.classList.add('selected');

            const title = this.querySelector('.inspection-title').textContent.trim();
            const subtitle = this.querySelector('.inspection-subtitle').textContent.trim();
            const alertMessage = `Title: ${title}\nType: ${subtitle}`;
            alert("som" + alertMessage);
        }

        // Add this function at the beginning of your script section
        function showAnomalyDetails(anomaly) {
            const details = {
                'Image Name': anomaly.properties['image name'].split('.')[0],
                'Block': anomaly.properties.block,
                'Inverter': anomaly.properties.inverter,
                'SCB': anomaly.properties.scb,
                'String': anomaly.properties.string,
                'Module': anomaly.properties.panel,
                'Anomaly Type': anomaly.properties.anomaly_type,
                'Confidence': anomaly.properties.confidence
            };

            let message = 'Anomaly Details:\n\n';
            for (const [key, value] of Object.entries(details)) {
                message += `${key}: ${value}\n`;
            }

            // Add complete anomaly object for debugging
            console.log('Complete Anomaly Object:', anomaly);
            alert("Anomaly Details:\n" + message + "\nComplete object logged to console");
        }

        function loadAnomalies() {
            fetch('/get_anomalies/{{audit.id}}')
                .then(response => response.json())
                .then(data => {
                    anomalyData = data;
                    anomalyMarkers = data.map(anomaly => {
                        const marker = L.marker([anomaly.geometry.coordinates[1], anomaly.geometry.coordinates[0]], {
                            icon: L.divIcon({
                                className: 'anomaly-marker',
                                html: `<div class="marker-content">${anomaly.properties.anomaly_type}</div>`
                            })
                        });

                        // Add click handler here where marker is created
                        marker.on('click', function (e) {
                            showAnomalyDetails(anomaly);
                        });

                        return marker;
                    });
                    anomalyMarkers.forEach(marker => marker.addTo(map));
                });
        }

        function handleAnomalyClick(element) {
            // Get the clicked item
            const clickedItem = element.closest('.inspection-item');
            console.log("---element", element)

            // Check if the clicked item is already selected
            if (clickedItem.classList.contains('selected')) {
                // If already selected, deselect it
                clickedItem.classList.remove('selected');

                // Show the top panel and hide the bottom panel
                const divA = document.getElementById('divATop');
                const divB = document.getElementById('divABottom');
                divA.classList.remove('hidden');
                divB.classList.add('hidden');
                const extent = vectorLayer.getSource().getExtent();

                map.getView().setCenter([0, 0]); // Reset map position to initial position
                map.getView().setZoom(0); // Reset map zoom to initial zoom level
                const vectorLayer = map.getLayers().getArray()[3]; // Assuming vectorLayer is the 4th layer in the map
                if (extent && extent.every(Number.isFinite)) {
                    map.getView().fit(extent, {
                        padding: [20, 20, 20, 20],
                    });
                }
                return; // Exit the function
            }

            // If not selected, proceed with normal selection
            // Remove 'selected' class from all items
            document.querySelectorAll('.inspection-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add 'selected' class to the clicked item
            clickedItem.classList.add('selected');

            // Get the anomaly data from the data attribute
            const anomalyDataString = element.getAttribute('data-anomaly');

            const divA = document.getElementById('divATop');
            const divB = document.getElementById('divABottom');
            divA.classList.add('hidden');
            divB.classList.remove('hidden');
            const validJsonString = anomalyDataString.replace(/'/g, '"');
            const anomalyData = JSON.parse(validJsonString);
            showLoader();

            let Latitude = anomalyData.properties.Latitude
            let Longitud = anomalyData.properties.Longitude
            let image_name = anomalyData.properties['name']


            // Add small delay to show loader, then process data
            setTimeout(() => {
                displayAnomalyData(anomalyData);
            }, 500);

            zoomToTile(Latitude, Longitud, image_name)
        }


        function handleAnomalyClickMap(data_anomaly) {

            // Remove 'selected' class from all items
            // document.querySelectorAll('.inspection-item').forEach(item => {
            //     item.classList.remove('selected');
            // });

            // Add 'selected' class to the clicked item's parent
            // element.closest('.inspection-item').classList.add('selected');

            // Get the anomaly data from the data attribute
            const anomalyDataString = data_anomaly //element.getAttribute('data-anomaly');

            // Now you have access to the full anomaly object

            const divA = document.getElementById('divATop');
            const divB = document.getElementById('divABottom');
            divA.classList.add('hidden');
            divB.classList.remove('hidden');
            // const validJsonString = anomalyDataString.replace(/'/g, '"');
            // console.log("---validJsonString", validJsonString.type, typeof validJsonString)
            const anomalyData = { "properties": data_anomaly };
            showLoader();

            let Latitude = anomalyData.properties.Latitude
            let Longitud = anomalyData.properties.Longitude
            let image_name = anomalyData.properties['name']
            console.log("---image_name", image_name)

            // Add small delay to show loader, then process data
            setTimeout(() => {
                displayAnomalyData(anomalyData);
            }, 500);
            console.log("zoom leve")
            zoomToTile(Latitude, Longitud, image_name)



        }

        function zoomToTile(lat, lon, imageName) {
            const coordinate = [lon, lat];
            let zoomLevel = 21
            view.setCenter([lon, lat]);
            view.setZoom(zoomLevel);
            console.log("---log outside", lon, lat, imageName)
            if (!imageName) {
                return
            }
            const highlightStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'black',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(0, 0, 0, 0.7)' // darker black with 70% opacity
                })
            });
            // Reset styles
            vectorLayer.getSource().getFeatures().forEach(f => f.setStyle(null));

            const matchedFeatures = vectorLayer.getSource().getFeatures().filter(f => {
                return f.get('name') === imageName;
            });

            if (matchedFeatures.length === 0) {
                console.warn('No feature found with image name:', imageName);
                return;
            }

            matchedFeatures.forEach(f => f.setStyle(highlightStyle));

            // Zoom to first matching feature
            const geometry = matchedFeatures[0].getGeometry();
            const extent = geometry.getExtent();
            // view.fit(extent, { maxZoom: zoomLevel, duration: 500 });




            // // Reset previous selection style
            // if (selectedFeature) {
            //     console.log("---log coming",lon,  lat,selectedFeature)
            //     selectedFeature.setStyle(null); // revert to default style
            // }
            // const highlightStyle = new ol.style.Style({
            //     image: new ol.style.Circle({
            //         radius: 7,
            //         fill: new ol.style.Fill({ color: 'black' }),
            //         stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
            //     }),
            //     stroke: new ol.style.Stroke({ color: 'black', width: 3 }),
            //     fill: new ol.style.Fill({ color: 'rgba(0, 0, 0, 0.4)' })
            // });
            // // Find the nearest feature manually from vector source
            // const source = vectorLayer.getSource();
            // const features = source.getFeatures();

            // let closestFeature = null;
            // let minDistance = Infinity;

            // features.forEach(feature => {
            //     const geometry = feature.getGeometry();
            //     const distance = ol.sphere.getDistance(geometry.getClosestPoint(coordinate), coordinate);
            //     if (distance < minDistance) {
            //         minDistance = distance;
            //         closestFeature = feature;
            //     }
            // });

            // // Set style if within a reasonable distance
            // if (closestFeature && minDistance < 20) {  // 20 meters threshold
            //     selectedFeature = closestFeature;
            //     selectedFeature.setStyle(highlightStyle);
            // }
            // // Find the closest feature

        }



        function displayAnomalyData(anomalyData) {
            let properties = anomalyData.properties
            const detailsContainer = document.getElementById('anomalyDetails');
            const s3BasePath = "{{ s3_base_path }}";
            const imageName = properties['Image name'] || properties['Image na'] || 'N/A';
            const imagePath = imageName !== 'N/A' ? `${s3BasePath}/zip_images/${imageName}` : '{{ url_for("static", filename="images/data_check.png") }}';
            let audit_id_value = "{{ audit._id }}"
            const resolve_status = anomalyData.resolve_status
            console.log("log data coming", resolve_status)

            const detailsHTML = `
                <div class="image-container">
                    <img class="upper-section"
                        src="${imagePath}"
                        alt="Anomaly Image"
                        onerror="this.src='{{ url_for('static', filename='images/data_check.png') }}'" />
                    <button class="download-btn" onclick="downloadImage('${imagePath}', '${imageName}')" title="Download Image">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                    </button>
                </div>
                <hr>
                <div class="detail-boxes-container">
                    <div class="detail-box">
                        <span class="detail-label">Anomaly Type</span>
                        <span class="detail-value">${properties.Anomaly}</span>
                    </div>

                    <div class="detail-box">
                        <span class="detail-label">Severity</span>
                        <span class="detail-value">${properties.Severity}</span>
                    </div>

                  <div class="detail-box">
                        <span class="detail-label">Irradiance</span>
                        <span class="detail-value">${properties['Irradian']}</span>
                    </div>

                     <div class="detail-box">
                        <span class="detail-label">ŒîT(T2 - T1)</span>
                        <span class="detail-value">${properties['Hotspot']}</span>
                    </div>


                    <div class="detail-box">
                        <span class="detail-label">Lat,Long</span>
                        <span class="detail-value">${properties['Latitude']}, ${properties['Longitude']} <br/>
                        <a title="View on map" href="https://maps.google.com/?q=${properties['Latitude']},${properties['Longitude']}" target="_blank"><svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-map"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7l6 -3l6 3l6 -3v13l-6 3l-6 -3l-6 3v-13" /><path d="M9 4v13" /><path d="M15 7v13" /></svg></a>
                        </span>
                    </div>

                    <div class="detail-box">
                        <span class="detail-label">Date Time</span>
                        <span class="detail-value">${properties['Date']}, ${properties['Time']}</span>
                    </div>

                   
                

                </div>
                 <div class="detail-box">
                        <span class="detail-label">Localisation</span>
                        <span class="detail-value">${properties['ID']}</span>
                    </div>

                <div class="button-container">
                    ${resolve_status === 'resolved' ?
                    `<button class="action-button pending-btn" onclick="toggleAnomalyStatus('${audit_id_value}', '${imageName}', this, 'pending')">
                            Pending
                        </button>` :
                    `<button class="action-button resolve-btn" onclick="toggleAnomalyStatus('${audit_id_value}', '${imageName}', this, 'resolved')">
                            Resolve
                        </button>`
                }
                </div>
            `;

            detailsContainer.innerHTML = detailsHTML;
        }

        function showLoader() {

            const detailsContainer = document.getElementById('anomalyDetails');



            // Show loader in the details container
            detailsContainer.innerHTML = `
                <div class="loader-container">
                    <div class="loader"></div>
                    <div class="loader-text">Loading anomaly details...</div>
                </div>
            `;
        }

        function toggleGeojson() {
            // Don't allow toggling if in thermal mode


            const button = document.querySelector('.toggle-geojson');
            const isVisible = vectorLayer.getVisible();

            vectorLayer.setVisible(!isVisible);
            button.classList.toggle('active');

            // Update button text and state
            if (!isVisible) {
                button.textContent = 'Hide Anamoly';
                button.setAttribute('data-state', 'visible');
            } else {
                button.textContent = 'Show Anamoly';
                button.setAttribute('data-state', 'hidden');
            }
        }

        // Initialize button state on page load
        document.addEventListener('DOMContentLoaded', function () {
            const button = document.querySelector('.toggle-geojson');
            const isVisible = vectorLayer.getVisible();

            if (isVisible) {
                button.classList.add('active');
                button.textContent = 'Hide Anamoly';
                button.setAttribute('data-state', 'visible');
            } else {
                button.classList.remove('active');
                button.textContent = 'Show Anamoly';
                button.setAttribute('data-state', 'hidden');
            }
        });

        // Add this new function to handle GeoJSON data refresh


        // Initialize global variables
        let geojsonData = {
            type: "FeatureCollection",
            features: {{ geojson | tojson | safe }}
        };
        let selectedFeature = null;

        const fault_colors = {{ fault_colors | safe }};
        const visual_ortho = {{ visual_ortho | tojson | safe }};
        const thermal_ortho = {{ thermal_ortho | tojson | safe }};
        const s3BaseURL = "{{s3_tif_base_url}}";

        console.log("thermal_ortho", thermal_ortho)

        const view = new ol.View({
            projection: 'EPSG:4326',
            center: [77.4095, 14.2476],
            zoom: 17
        });

        // Satellite Base Layer (ESRI World Imagery)
        const baseLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attributions: 'Tiles ¬© Esri'
            })
        });

        const format = new ol.format.GeoJSON();
        const features = format.readFeatures(geojsonData, {
            dataProjection: 'EPSG:4326',
            featureProjection: 'EPSG:4326'
        });


        const visualLayers = visual_ortho.map((url, index) => new ol.layer.WebGLTile({
            source: new ol.source.GeoTIFF({
                sources: [{
                    url: `${s3BaseURL}/${url.tif_path}`,
                    bands: [1, 2, 3],
                    nodata: 0,  // Adjust if needed
                    transparent: true
                }]
            }),
            // visible: index === 0,  // Only first visible by default
            opacity: 0.8,
            title: `Visual Layer ${index + 1}`
        }));
        // Thermal ortho as separate layers
        const thermalLayers = thermal_ortho.map((url, index) => new ol.layer.WebGLTile({
            source: new ol.source.GeoTIFF({
                sources: [{
                    url: `${s3BaseURL}/${url.tif_path}`,
                    bands: [1, 2, 3],  // Adjust if your TIFFs are not RGB
                    nodata: 255
                }]
            }),
            visible: false,  // Show only first by default
            opacity: 1,
            title: `Thermal Layer ${index + 1}`
        }));

        const vectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector({ features: features }),
            style: function (feature) {
                const defect = feature.values_.Anomaly;
                const baseColor = fault_colors[feature.values_.Anomaly] || '#999999';
                const fillColor = hexToRgba(baseColor, 1);

                return new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 6,
                        fill: new ol.style.Fill({ color: baseColor }),
                        stroke: new ol.style.Stroke({
                            color: '#fff',
                            width: 1
                        })
                    }),
                    stroke: new ol.style.Stroke({
                        color: baseColor,
                        width: 2
                    }),
                    fill: new ol.style.Fill({
                        color: fillColor
                    })
                });
            }
        });

        const map = new ol.Map({
            target: 'map',
            view: view,
            layers: [baseLayer, ...visualLayers, ...thermalLayers, vectorLayer],
            controls: [
                new ol.control.Zoom(),
                new ol.control.Attribution(),
                new ol.control.FullScreen()
            ]
        });

        map.on('click', function (event) {

            map.forEachFeatureAtPixel(event.pixel, function (feature) {
                console.log(feature.values_);
                handleAnomalyClickMap(feature.values_)

            });
        });

        const btnVisual = document.getElementById('btnVisual');
        const btnThermal = document.getElementById('btnThermal');

        // Add variable to track vector layer state
        let vectorLayerWasVisible = true;

        btnVisual.addEventListener('click', () => {
            const button = document.querySelector('.toggle-geojson');

            // visualLayer.setVisible(true);
            // thermalLayer.setVisible(false);
            visualLayers.forEach((layer, i) => layer.setVisible(i === i));  // Show only first by default

            // thermalLayers.forEach((layer, i) => layer.setVisible(i !== i));  // Show only first by default
            thermalLayers.forEach((layer) => layer.setVisible(false));


            // Restore vector layer visibility based on previous state
            vectorLayer.setVisible(vectorLayerWasVisible);

            // Update toggle button state
            if (vectorLayerWasVisible) {
                button.classList.add('active');
                button.textContent = 'Hide Anamoly';
                button.setAttribute('data-state', 'visible');
            } else {
                button.classList.remove('active');
                button.textContent = 'Show Anamoly';
                button.setAttribute('data-state', 'hidden');
            }

            // Enable the toggle button
            button.style.pointerEvents = 'auto';
            button.style.opacity = '1';

            btnVisual.classList.add('active');
            btnThermal.classList.remove('active');
        });

        btnThermal.addEventListener('click', () => {
            // Store current vector layer visibility state before hiding
            vectorLayerWasVisible = vectorLayer.getVisible();

            // thermalLayer.setVisible(true);
            thermalLayers.forEach((layer, i) => layer.setVisible(i === i));  // Show only first by default

            // visualLayer.setVisible(false);
            // visualLayers.forEach((layer, i) => layer.setVisible(i !== i));  // Show only first by default
            visualLayers.forEach((layer) => layer.setVisible(false));

            vectorLayer.setVisible(false);

            // Disable the toggle button
            const button = document.querySelector('.toggle-geojson');
            button.style.pointerEvents = 'none';
            button.style.opacity = '0.5';
            button.classList.remove('active');
            button.textContent = 'Show Anamoly';
            button.setAttribute('data-state', 'hidden');

            btnThermal.classList.add('active');
            btnVisual.classList.remove('active');
        });

        function hexToRgba(hex, alpha) {
            const bigint = parseInt(hex.replace('#', ''), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgba(${r},${g},${b},${alpha})`;
        }

        function downloadImage(url, filename) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const blobUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(blobUrl);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('Error downloading image:', error);
                    alert('Failed to download image. Please try again.');
                });
        }

        // Navigation functions
        // Navigation functions
        function openOverview() {
            const plantId = '{{ plant._id }}';
            window.location.href = '/plant/' + plantId + '/overview';
        }

        function openSiteDetails() {
            const plantId = '{{ plant._id }}';
            window.location.href = '/plant/' + plantId + '/site-details';
        }

        // Function for opening the anomalies page (this page)
        function openAnomaliesMap() {
            const plantId = '{{ plant._id }}';
            // Try to get the first audit for this plant and redirect to its anomalies
            fetch(`/api/plants/${plantId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.plant.audits && data.plant.audits.length > 0) {
                        // Redirect to the first audit's detail page
                        window.location.href = '/audit/' + data.plant.audits[0];
                    } else {
                        // Fallback to plant detail page
                        window.location.href = '/plant/' + plantId;
                    }
                })
                .catch(error => {
                    console.error('Error fetching plant data:', error);
                    // Fallback to plant detail page
                    window.location.href = '/plant/' + plantId;
                });
        }

        // User dropdown functionality
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdown');
            const userBtn = document.querySelector('.user-btn');
            
            if (userBtn && dropdown && !userBtn.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

</script>


</body>

</html>