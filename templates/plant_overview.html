<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ plant.name }} - Overview</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo/logo1.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-green: #16A34A;
            --light-gray-bg: #F8FAFC;
            --border-color: #EAF0F6;
            --text-primary: #0D1A2B;
            --text-secondary: #64748B;
            --white: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--light-gray-bg);
            color: var(--text-primary);
            font-size: 14px;
            margin: 0;
        }

        .main-app {
            display: flex;
        }

        /* Fixed Sidebar */
        .sidebar {
            width: 150px;
            height: 100vh;
            background-color: white;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar-logo {
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            padding: 10px;
        }

        .sidebar-logo img {
            width: 100%;
            height: auto;
            max-width: 150px;
            display: block;
            margin: 0 auto;
        }

        .sidebar-logo h2 {
            color: var(--primary-green);
            font-size: 20px;
            font-weight: 700;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 10px;
            color: black;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: var(--primary-green);
            color: white;
            border-right: 3px solid var(--primary-green);
        }

        .sidebar-menu svg {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            min-width: 20px;
            min-height: 20px;
            flex-shrink: 0;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 200;
            background: var(--primary-green);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
        }

        .sidebar-toggle svg {
            width: 20px;
            height: 20px;
        }

        /* Main Content Styles */
        .main-content {
            flex-grow: 1;
            margin-left: 150px;
            padding: 24px 160px;
            padding-top: 80px;
            max-width: calc(100vw - 170px);
            overflow-x: hidden;
            box-sizing: border-box;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background-color: var(--light-gray-bg);
            padding: 16px 32px;
            position: fixed;
            top: 0;
            left: 150px;
            right: 0;
            z-index: 50;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left p { 
            font-size: 23px; 
            color: var(--text-secondary); 
            margin: 0;
        }

        .header-left strong { 
            color: var(--text-primary); 
        }

        .header-right-buttons {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-dropdown {
            position: relative;
        }

        .user-btn {
            background: var(--light-gray-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-btn:hover {
            background: var(--border-color);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: none;
            min-width: 150px;
            z-index: 1000;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 15px;
            text-align: left;
            color: var(--text-primary);
            text-decoration: none;
            border: none;
            background: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown-item:hover {
            background: var(--light-gray-bg);
        }

        .header-center {
            display: flex; 
            align-items: center; 
            gap: 6px;
            background-color: #F1F5F9;
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .top-btn {
            padding: 6px 14px; 
            background: transparent; 
            border: none;
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600;
            color: #334155; 
            cursor: pointer;
            transition: all 0.2s;
        }

        .top-btn.active { 
            background: var(--primary-green); 
            color: var(--white); 
        }

        .top-btn:hover {
            background: var(--primary-green);
            color: var(--white);
        }

        .back-button {
            display: flex; 
            align-items: center; 
            gap: 8px;
            padding: 9px 16px; 
            background: var(--primary-green);
            color: var(--white); 
            border: none; 
            border-radius: 8px;
            font-size: 14px; 
            font-weight: 500; 
            cursor: pointer;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #15803D;
        }

        /* Top Section Layout - 40% left metrics, 60% right status bars */
        .top-section-layout {
            display: grid;
            grid-template-columns: 40% 60%;
            gap: 16px;
            margin-bottom: 20px;
            align-items: start;
        }

        .overview-metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            flex-grow: 1;
        }
        
        /* Metric Cards - Smaller with minimal gap */
        .metric-card {
            background-color: var(--white); 
            border: 1px solid var(--border-color);
            border-radius: 6px; 
            padding: 8px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            height: 70px;
        }

        .metric-icon-wrapper {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            order: 0; /* Keep at the beginning (left side) */
            margin-right: 10px; /* Increase right margin for spacing */
            margin-left: 0; /* Remove left margin */
        }

        .metric-icon-wrapper.red { background-color: #FEF2F2; }
        .metric-icon-wrapper.green { background-color: #ECFDF5; }
        .metric-icon-wrapper.orange { background-color: #FFF7ED; }
        .metric-icon-wrapper.blue { background-color: #EFF6FF; }
        .metric-icon-wrapper.purple { background-color: #F5F3FF; }

        .metric-icon { 
            width: 18px;
            height: 18px;
            color: currentColor;
        }

        .metric-icon.red { color: #DC2626; }
        .metric-icon.green { color: #10B981; }
        .metric-icon.orange { color: #F97316; }
        .metric-icon.blue { color: #3B82F6; }
        .metric-icon.purple { color: #8B5CF6; }

        .metric-info { 
            flex-grow: 1; 
            text-align: left; /* Change from center to left */
            order: 1;
        }

        .metric-info p { 
            font-size: 16px; 
            color: #334155; 
            margin: 6; 
            line-height: 1.0;
        }

        .metric-info h3 { 
            font-size: 16px; 
            font-weight: 600; 
            color: black; 
            margin: 1px 0; 
            line-height: 1.0;
        }

        /* Status Bars Container - Right side 60% */
        .status-bars-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 98%;
        }

        .status-section {
            background-color: var(--white); 
            border: 1px solid var(--border-color);
            border-radius: 6px; 
            padding: 34px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .status-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 12px 0;
        }

        .single-status-bar {
            width: 100%;
            height: 16px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #F3F4F6;
            position: relative;
            display: flex;
            margin-bottom: 12px;
        }

        .status-segment {
            height: 100%;
            transition: width 0.6s ease;
            position: relative;
        }

        .status-segment.pending { background-color: #7173e4; }
        .status-segment.resolved { background-color: #7ed957; }
        .status-segment.not-found { background-color: #a6a6a6; }
        
        .status-segment.high { background-color: #FF0000; }
        .status-segment.medium { background-color: #FF914D; }
        .status-segment.low { background-color: #7ed957; }

        .status-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Severity info button and popup styles */
        .severity-title-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .info-icon:hover {
            color: var(--primary-green);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .popup-container {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        
        .popup-close {
            position: absolute;
            top: 12px;
            right: 12px;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-secondary);
        }
        
        .popup-content h3 {
            margin-top: 0;
            color: var(--primary-green);
            margin-bottom: 16px;
        }
        
        .popup-content p {
            margin-bottom: 12px;
            line-height: 1.5;
        }
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Bottom Section - Two equal boxes side by side */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        /* Charts Section - Pie chart and severity map */
        .charts-section {
            display: grid; 
            grid-template-columns: 1fr 1fr;
            gap: 20px; 
            margin-bottom: 20px; 
            align-items: start;
        }

        .pie-chart-container {
            background: var(--white); 
            border: 1px solid var(--border-color);
            border-radius: 6px; 
            padding: 12px; 
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            height: 450px;
            box-sizing: border-box;
            padding-bottom: 80px; /* Add padding at the bottom for the legend */
        }

        /* Anomaly Table Section - Right side box */
        .anomaly-table-section {
            background: var(--white); 
            border: 1px solid var(--border-color);
            border-radius: 6px; 
            padding: 12px; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            height: 450px;
            box-sizing: border-box;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            text-align: center;
        }

        .anomaly-table-container {
            flex: 1;
            overflow-y: auto;
            max-height: 450px;
        }

        .pie-chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            text-align: center;
        }
        
        .pie-chart-wrapper { 
            max-width: 240px;
            max-height: 240px;
            width: 100%;
            height: 240px;
            margin: 0 auto 20px auto; 
            position: relative; 
            flex-shrink: 0;
        }
        
        .chart-center-text { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            text-align: center; 
            pointer-events: none;
            z-index: 10;
        }
        
        .center-value { 
            font-size: 24px;
            font-weight: 700; 
            color: var(--text-primary); 
            line-height: 1.1;
        }

        .center-label { 
            font-size: 10px;
            color: var(--text-secondary); 
            margin-top: 2px;
            line-height: 1.1;
            font-weight: 500;
        }
        
        .pie-chart-legend { 
            display: flex; 
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
            max-height: none;
            padding: 0 4px;
            justify-content: center;
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
        }
        
        .pie-chart-legend .legend-item {
            justify-content: flex-start;
            padding: 3px 6px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .pie-chart-legend .legend-item span {
            font-size: 11px;
            font-weight: 500;
        }

        .legend-color {
            width: 6px;
            height: 6px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        /* Severity Map Section */
        .severity-map-section { 
            background: var(--white); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            padding: 16px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .severity-map-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-align: center;
        }

        .severity-map-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--primary-green);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .severity-map-btn:hover {
            background: #15803D;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .anomaly-table-wrapper { 
            background: var(--white); 
            border: 1px solid var(--border-color);
            border-radius: 12px; 
            padding: 28px 32px;
            padding-top: 20px; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            height: 100%;
            box-sizing: border-box;
        }
        
        .table-header { 
            margin-bottom: 16px;
            padding: 0;
            display: flex;
            justify-content: flex-start;
        }

        .table-header h3 { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--text-primary);
        }
        
        .anomaly-table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        
        .anomaly-table thead th {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: capitalize;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .anomaly-table th, .anomaly-table td { 
            padding: 8px 0px;
            text-align: center; 
            font-size: 13px;
            border-bottom: 1px solid #F1F5F9;
        }
        
        .anomaly-table tr:last-child td { 
            border-bottom-style: none; 
        }
        
        .anomaly-table th { 
            color: var(--text-secondary); 
            font-weight: 500; 
            text-transform: uppercase; 
        }
        
        .anomaly-table td { 
            color: #334155; 
            font-weight: 500; 
        }
        
        .anomaly-table th:nth-child(2), .anomaly-table td:nth-child(2) {
            text-align: center;
            font-weight: 600; 
            min-width: 50px;
        }

        .anomaly-table th:nth-child(3), .anomaly-table td:nth-child(3) {
            text-align: right;
            font-weight: 600; 
            min-width: 70px;
        }

        .table-anomaly-type {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .table-color-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        /* Bar Chart Section - Bottom area with toggle */
        .bar-chart-container { 
            background: var(--white); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            margin-top: 20px;
            max-width: 100%;
            overflow-x: hidden;
        }

        .chart-toggle-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            justify-content: center;
        }

        .chart-toggle-btn {
            padding: 8px 16px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .chart-toggle-btn.active {
            background: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }

        .chart-toggle-btn:hover {
            border-color: var(--primary-green);
        }

        #anomalyChartSection, #severityChartSection {
            display: none;
        }

        #anomalyChartSection.active, #severityChartSection.active {
            display: block;
        }
        
        .bar-chart-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
        }

        .bar-chart-title-wrapper {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .bar-chart-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .bar-chart-tabs { 
            display: flex; 
            gap: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .bar-chart-tabs span { 
            cursor: pointer; 
            padding-bottom: 8px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .bar-chart-tabs span.active { 
            color: var(--text-primary); 
            border-bottom: 2px solid var(--primary-green);
        }
        
        .chart-filters { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        .chart-filters button {
            background: var(--white); 
            border: 1px solid var(--border-color);
            padding: 8px 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .chart-filters button:hover {
            background: var(--light-gray-bg);
            border-color: var(--primary-green);
        }

        .chart-filters button svg {
            width: 16px;
            height: 16px;
            vertical-align: middle;
            margin-right: 6px;
        }
        
        #stackedBarChartContainer, #severityBarChartContainer { 
          height: 260px;
          margin-bottom: 16px;
          max-width: 100%;
          margin-left: 0;
          margin-right: 0;
          box-sizing: border-box;
          padding: 0 70px;
        }
        
        .bar-chart-legend { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px 16px;
            justify-content: center; 
            margin-top: 12px;
            padding: 0 16px;
            margin-bottom: 16px;
        }

        .bar-chart-legend .legend-item {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bar-chart-actions {
            display: flex;
            justify-content: center;
            margin-top: 16px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .severity-map-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: var(--primary-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .severity-map-btn:hover {
            background: #15803D;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #0D1A2B;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #0D1A2B transparent transparent transparent;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .info-icon {
            display: inline-flex;
            width: 16px;
            height: 16px;
            background-color: #e2e8f0;
            border-radius: 50%;
            font-size: 10px;
            align-items: center;
            justify-content: center;
            color: #334155;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .top-section-layout {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .overview-metrics-grid {
                order: 1;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .status-bars-container {
                order: 2;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .bottom-section {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .pie-chart-container {
                order: 1;
            }

            .anomaly-table-section {
                order: 2;
            }
        }

        @media (max-width: 900px) {
            .overview-metrics-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .status-bars-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        @media (max-width: 768px) {
            .sidebar-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-visible {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 16px;
                padding-top: 80px;
                max-width: 100vw;
                overflow-x: hidden;
            }

            .header {
                left: 0;
                padding: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                padding-left: 60px;
            }

            .header-right-buttons {
                width: 100%;
                justify-content: space-between;
            }

            .header-center {
                width: 100%;
                justify-content: center;
            }

            .overview-metrics-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .status-bars-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .bottom-section {
                grid-template-columns: 1fr;
            }

            .bar-chart-container {
                margin-left: 0;
                margin-right: 0;
                padding: 16px;
            }

            #stackedBarChartContainer, #severityBarChartContainer {
                height: 280px;
                padding: 0 8px;
            }

            .bar-chart-legend {
                padding: 0 12px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 12px;
                padding-top: 100px;
            }

            .metric-card {
                padding: 11px;
                height: 90px;
            }

            .metric-icon-wrapper {
                width: 28px;
                height: 28px;
            }

            .metric-icon {
                width: 16px;
                height: 16px;
            }

            .metric-info h3 {
                font-size: 14px;
            }

            .metric-info p {
                font-size: 10px;
            }

            .anomaly-status-card {
                padding: 20px;
                min-height: 150px;
            }

            .anomaly-status-card h3 {
                font-size: 16px;
            }

            .status-bar {
                height: 12px;
            }

            .pie-chart-container {
                padding: 20px;
            }

            .pie-chart-wrapper {
                max-width: 240px;
                max-height: 240px;
                height: 240px;
            }

            .center-value {
                font-size: 28px;
            }

            .anomaly-table-wrapper {
                padding: 20px;
            }

            .bar-chart-container {
                padding: 16px;
            }

            .bar-chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .chart-filters {
                width: 100%;
                justify-content: flex-end;
            }

            #stackedBarChartContainer {
                height: 250px;
                padding: 0 8px;
            }

            .bar-chart-legend {
                padding: 0 8px;
                justify-content: flex-start;
            }

            .metric-icon-wrapper {
                width: 32px;
                height: 32px;
            }

            .metric-icon {
                width: 20px;
                height: 20px;
            }

            .pie-chart-wrapper {
                max-width: 240px;
                max-height: 240px;
                height: 240px;
            }

            .center-value {
                font-size: 24px;
            }

            .center-label {
                font-size: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="main-app">
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <div class="sidebar">
            <div class="sidebar-logo">
                <img src="{{ url_for('static', filename='images/logo/logo1.png') }}" alt="Solar Plant Manager Logo">
            </div>
            <ul class="sidebar-menu">
                <li>
                    <a href="/homepage">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                            </path>
                        </svg>
                        Home
                    </a>
                </li>
                <li>
                    <a href="/homepage" class="active">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                            <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span>Thermography</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <path d="M3 20 V4 H21" /> <!-- Axes -->
                        <path d="M3 18 C6 14, 12 8, 21 4" /> <!-- IV Curve -->
                      </svg>
                        <span>IV Curve Testing</span>
                    </a>
                  </li>

                  <li>
                    <a href="#">
                      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <!-- Simple glowing cell icon -->
                        <rect x="4" y="4" width="16" height="16" rx="2" ry="2" />
                        <path d="M4 10h16M4 14h16" />
                        <path d="M10 4v16" />
                      </svg>
                        <span>EL Testing</span>
                    </a>
                  </li>
                  <li>
                    <a href="#">
                      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <!-- Transmission pole with cross arms and wires -->
                        <path d="M12 3v18" /> <!-- Vertical pole -->
                        <path d="M6 6h12M4 10h16M6 14h12" /> <!-- Cross arms -->
                        <path d="M6 6l-2 4M18 6l2 4M6 14l-2-4M18 14l2-4" /> <!-- Wires -->
                      </svg>
                        <span>Transmission Line</span>
                    </a>
                  </li>
                <li>
                    <a href="#">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4">
                            </path>
                        </svg>
                        <span>Data</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <p>Plants / <strong>{{ plant.name }}</strong></p>
                </div>
                <div class="header-right-buttons"> 
                    <div class="header-center">
                        <button class="top-btn active">Overview</button>
                        <button class="top-btn" onclick="openAnomaliesMap()">Anomalies</button>
                        <button class="top-btn" onclick="openSiteDetails()">Site Details</button>
                        <button class="top-btn">Report</button>
                    </div>
                    <div class="user-dropdown">
                        <button class="user-btn" onclick="toggleUserDropdown()">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span>{{ session.user_name or 'User' }}</span>
                        </button>
                        <div class="dropdown-menu" id="userDropdown">
                            <a href="/logout" class="dropdown-item">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                                Logout
                            </a>
                        </div>
                    </div>
                    <button class="back-button" onclick="window.history.back()">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back to Plants
                    </button> 
                </div>
            </div>

            <div class="top-section-layout">
                <div class="overview-metrics-grid"> 
                    <div class="metric-card">
                        <div class="metric-icon-wrapper red">
                            <svg class="metric-icon red" fill="currentColor" viewBox="0 0 20 20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div class="metric-info">
                            <p>Power Loss <span class="tooltip"><span class="info-icon">i</span>
                                <span class="tooltip-text">Estimated power loss due to detected anomalies across the plant</span>
                            </span></p>
                            <h3>{{ analytics.power_loss or '' }} {{ 'kW' if analytics.power_loss else '' }}</h3>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon-wrapper orange">
                            <svg class="metric-icon orange" fill="currentColor" viewBox="0 0 20 20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <div class="metric-info">
                            <p>Revenue Loss/yr <span class="tooltip"><span class="info-icon">i</span>
                                <span class="tooltip-text">Estimated annual revenue loss based on current power generation deficits</span>
                            </span></p>
                            <h3>{{ 'â‚¹' + analytics.revenue_loss if analytics.revenue_loss else '' }}</h3>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon-wrapper green">
                            <svg class="metric-icon green" fill="currentColor" viewBox="0 0 20 20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div class="metric-info">
                            <p>AC Capacity</p>
                            <h3>{{ plant.ac_capacity or '' }} {{ 'MW' if plant.ac_capacity else '' }}</h3>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon-wrapper purple">
                            <svg class="metric-icon purple" fill="currentColor" viewBox="0 0 20 20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div class="metric-info">
                            <p>DC Capacity</p>
                            <h3>{{ plant.dc_capacity or '' }} {{ 'MW' if plant.dc_capacity else '' }}</h3>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon-wrapper blue">
                            <svg class="metric-icon blue" fill="currentColor" viewBox="0 0 20 20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </div>
                        <div class="metric-info">
                            <p>Total Modules</p>
                            <h3>{{ plant.total_modules_inspected or '' }}</h3>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon-wrapper green">
                            <svg class="metric-icon green" fill="currentColor" viewBox="0 0 20 20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h10a2 2 0 002-2v-4a2 2 0 00-2-2h-2m-4-6H3m4 6h4m-4 0V5"></path>
                            </svg>
                        </div>
                        <div class="metric-info">
                            <p>Land Area (acres)</p>
                            <h3>{{ plant.land_area or '' }}</h3>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon-wrapper orange">
                            <svg class="metric-icon orange" fill="currentColor" viewBox="0 0 20 20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div class="metric-info">
                            <p>No. of Inverters</p>
                            <h3>{{ plant.no_of_inverters or '' }}</h3>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon-wrapper blue">
                            <svg class="metric-icon blue" fill="currentColor" viewBox="0 0 20 20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </div>
                        <div class="metric-info">
                            <p>No. of Blocks</p>
                            <h3>{{ plant.no_of_blocks or '' }}</h3>
                        </div>
                    </div>
                </div>
                <div class="status-bars-container"> 
                    <div class="status-section">
                        <h3>Anomaly Status (Total 100)</h3>
                        <div class="single-status-bar" id="statusBar">
                            <div class="status-segment pending" id="pendingSegment"></div>
                            <div class="status-segment resolved" id="resolvedSegment"></div>
                            <div class="status-segment not-found" id="notFoundSegment"></div>
                        </div>
                        <div class="status-labels">
                            <div class="status-item">
                                <div class="status-dot" style="background-color: #7173e4;"></div>
                                <span>Pending <span id="pendingCount">25</span> (<span id="pendingPercent">25</span>%)</span>
                            </div>
                            <div class="status-item">
                                <div class="status-dot" style="background-color: #7ed957;"></div>
                                <span>Corrected <span id="resolvedCount">60</span> (<span id="resolvedPercent">60</span>%)</span>
                            </div>
                            <div class="status-item">
                                <div class="status-dot" style="background-color: #a6a6a6;"></div>
                                <span>Not Found <span id="notFoundCount">15</span> (<span id="notFoundPercent">15</span>%)</span>
                            </div>
                        </div>
                    </div>
                    <div class="status-section">
                        <div class="severity-title-container">
                            <h3>Severity Levels (Total 100)</h3>
                            <span class="info-icon" id="severityInfoBtn" title="Click for more information">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="M8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                </svg>
                            </span>
                        </div>
                        <div class="single-status-bar" id="severityBar">
                            <div class="status-segment high" id="highSegment"></div>
                            <div class="status-segment medium" id="mediumSegment"></div>
                            <div class="status-segment low" id="lowSegment"></div>
                        </div>
                        <div class="status-labels">
                            <div class="status-item">
                                <div class="status-dot" style="background-color: #FF0000;"></div>
                                <span>High <span id="highCount">30</span> (<span id="highPercent">30</span>%)</span>
                            </div>
                            <div class="status-item">
                                <div class="status-dot" style="background-color: #FF914D;"></div>
                                <span>Medium <span id="mediumCount">45</span> (<span id="mediumPercent">45</span>%)</span>
                            </div>
                            <div class="status-item">
                                <div class="status-dot" style="background-color: #7ed957;"></div>
                                <span>Low <span id="lowCount">25</span> (<span id="lowPercent">25</span>%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bottom-section">
                <div class="pie-chart-container">
                    <h3 class="pie-chart-title">Anomaly Distribution</h3>
                    <div class="pie-chart-wrapper">
                        <canvas id="anomalyDoughnutChart"></canvas>
                        <div class="chart-center-text">
                            <div class="center-value" id="chartCenterValue">0</div>
                            <div class="center-label">Anomalies</div>
                        </div>
                    </div>
                    <div id="doughnut-legend" class="pie-chart-legend"></div>
                </div>
                <div class="anomaly-table-section">
                    <h3 class="table-title">Anomaly Details</h3>
                    <div class="anomaly-table-container">
                        <table class="anomaly-table">
                            <thead>
                                <tr>
                                    <th>Anomaly Type</th>
                                    <th>Count</th>
                                    <th>%</th>
                                </tr>
                            </thead>
                            <tbody id="anomalyTableBody">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="bar-chart-container">
                <div class="chart-toggle-buttons">
                    <button class="chart-toggle-btn active" onclick="showAnomalyChart()">Anomaly Analysis</button>
                    <button class="chart-toggle-btn" onclick="showSeverityChart()">Severity Map</button>
                </div>

                <div id="anomalyChartSection" class="active">
                    <div class="bar-chart-header">
                        <div class="bar-chart-title-wrapper">
                            <span class="bar-chart-title">Block Wise Anomalies</span>
                        </div>
                        <div class="chart-filters">
                            <!-- Filters left blank as requested -->
                        </div>
                    </div>
                    <div id="stackedBarChartContainer">
                        <canvas id="stackedBarChart"></canvas>
                    </div>
                    <div id="bar-chart-legend" class="bar-chart-legend"></div>
                </div>

                <div id="severityChartSection">
                    <div class="bar-chart-header">
                        <div class="bar-chart-title-wrapper">
                            <span class="bar-chart-title">Severity Analysis</span>
                        </div>
                    </div>
                    <div id="severityBarChartContainer">
                        <canvas id="severityBarChart"></canvas>
                    </div>
                    <div id="severity-chart-legend" class="bar-chart-legend"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Severity Info Popup -->
    <div id="severityInfoPopup" class="popup-overlay">
        <div class="popup-container">
            <span class="popup-close" id="closePopup">&times;</span>
            <div class="popup-content">
                <h3>Severity Levels Explained</h3>
                <p>Severity levels help categorize anomalies based on their impact on system performance and safety:</p>
                <p><strong>High (Red):</strong> Critical anomalies that require immediate attention. These issues can cause significant power loss or pose safety risks if not addressed promptly.</p>
                <p><strong>Medium (Orange):</strong> Important issues that should be scheduled for maintenance in the near future. These anomalies may lead to decreased performance but are not immediately critical.</p>
                <p><strong>Low (Green):</strong> Minor issues that should be monitored but do not require immediate action. These are typically early indicators of potential future problems.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Severity Info Popup Functionality
            const severityInfoBtn = document.getElementById('severityInfoBtn');
            const severityInfoPopup = document.getElementById('severityInfoPopup');
            const closePopup = document.getElementById('closePopup');
            
            if (severityInfoBtn && severityInfoPopup && closePopup) {
                severityInfoBtn.addEventListener('click', function() {
                    severityInfoPopup.style.display = 'flex';
                });
                
                closePopup.addEventListener('click', function() {
                    severityInfoPopup.style.display = 'none';
                });
                
                severityInfoPopup.addEventListener('click', function(e) {
                    if (e.target === severityInfoPopup) {
                        severityInfoPopup.style.display = 'none';
                    }
                });
            }
            try {
                // Progress Data for Status and Severity with dynamic backend values
                const statusData = {
                    pending: {{ progress_data.pending or 25 }},
                    resolved: {{ progress_data.resolved or 60 }},
                    notFound: {{ progress_data.not_found or 15 }}
                };

                const severityData = {
                    high: {{ progress_data.high or 30 }},
                    medium: {{ progress_data.medium or 45 }},
                    low: {{ progress_data.low or 25 }}
                };

                // Update Combined Status Bars
                const statusTotal = statusData.pending + statusData.resolved + statusData.notFound;
                const statusPendingPercent = Math.round((statusData.pending / statusTotal) * 100);
                const statusResolvedPercent = Math.round((statusData.resolved / statusTotal) * 100);
                const statusNotFoundPercent = Math.round((statusData.notFound / statusTotal) * 100);

                // Update Status Bar Segments
                document.getElementById('pendingSegment').style.width = statusPendingPercent + '%';
                document.getElementById('resolvedSegment').style.width = statusResolvedPercent + '%';
                document.getElementById('notFoundSegment').style.width = statusNotFoundPercent + '%';
                
                // Update Status Legend
                document.getElementById('pendingCount').textContent = statusData.pending;
                document.getElementById('pendingPercent').textContent = statusPendingPercent;
                document.getElementById('resolvedCount').textContent = statusData.resolved;
                document.getElementById('resolvedPercent').textContent = statusResolvedPercent;
                document.getElementById('notFoundCount').textContent = statusData.notFound;
                document.getElementById('notFoundPercent').textContent = statusNotFoundPercent;

                // Update Combined Severity Bars
                const severityTotal = severityData.high + severityData.medium + severityData.low;
                const severityHighPercent = Math.round((severityData.high / severityTotal) * 100);
                const severityMediumPercent = Math.round((severityData.medium / severityTotal) * 100);
                const severityLowPercent = Math.round((severityData.low / severityTotal) * 100);

                // Update Severity Bar Segments
                document.getElementById('highSegment').style.width = severityHighPercent + '%';
                document.getElementById('mediumSegment').style.width = severityMediumPercent + '%';
                document.getElementById('lowSegment').style.width = severityLowPercent + '%';
                
                // Update Severity Legend
                document.getElementById('highCount').textContent = severityData.high;
                document.getElementById('highPercent').textContent = severityHighPercent;
                document.getElementById('mediumCount').textContent = severityData.medium;
                document.getElementById('mediumPercent').textContent = severityMediumPercent;
                document.getElementById('lowCount').textContent = severityData.low;
                document.getElementById('lowPercent').textContent = severityLowPercent;

                // Anomaly Data for Charts with dynamic backend values
                const anomalyData = {
                    labels: {{ anomaly_data.labels|default([
                        'Bypass Diode',
                        'Multi Cell',
                        'Cell',
                        'Partial String Offline',
                        'Vegetation',
                        'Physical Damage',
                        'Module Power Mismatch',
                        'Shading',
                        'Short Circuit',
                        'String Offline',
                        'Module Offline',
                        'Junction Box',
                        'Module Missing',
                        'Other'
                    ])|tojson }},
                    counts: {{ anomaly_data.counts|default([125, 87, 63, 42, 38, 29, 56, 34, 18, 25, 33, 15, 12, 8])|tojson }},
                    colors: [
                        '#FF914D',  // Bypass Diode
                        '#FFBF00',  // Multi Cell
                        '#FF0000',  // Cell
                        '#7173e4',  // Partial String Offline
                        '#2E7D32',  // Vegetation
                        '#C2185B',  // Physical Damage
                        '#65E667',  // Module Power Mismatch
                        '#E77148',  // Shading
                        '#506E9A',  // Short Circuit
                        '#FF1A94',  // String Offline
                        '#a6a6a6',  // Module Offline
                        '#7ed957',  // Junction Box
                        '#5CE1E6',  // Module Missing
                        '#8C52FF'   // Other
                    ]
                };

                const totalAnomalies = anomalyData.counts.reduce((a, b) => a + b, 0);
                document.getElementById('chartCenterValue').textContent = totalAnomalies;

                // Populate Anomaly Table
                const tableBody = document.getElementById('anomalyTableBody');
                if (tableBody) {
                    tableBody.innerHTML = '';
                    anomalyData.labels.forEach((label, index) => {
                        const percentage = ((anomalyData.counts[index] / totalAnomalies) * 100).toFixed(1);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div class="table-anomaly-type" style="display: flex; align-items: center; gap: 8px;">
                                    <div class="table-color-dot" style="background-color: ${anomalyData.colors[index]}; width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;"></div>
                                    <span>${label}</span>
                                </div>
                            </td>
                            <td>${anomalyData.counts[index]}</td>
                            <td>${percentage}%</td>
                        `;
                        tableBody.appendChild(row);
                    });
                }

                // Create Doughnut Chart with hover animation
                const doughnutCtx = document.getElementById('anomalyDoughnutChart');
                if (doughnutCtx) {
                    const doughnutLegend = document.getElementById('doughnut-legend');
                    doughnutLegend.innerHTML = '';
                    anomalyData.labels.forEach((label, i) => {
                        doughnutLegend.innerHTML += `
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: ${anomalyData.colors[i]}"></div>
                                <span>${label}</span>
                            </div>`;
                    });

                    new Chart(doughnutCtx, {
                        type: 'doughnut',
                        data: {
                            labels: anomalyData.labels,
                            datasets: [{
                                data: anomalyData.counts,
                                backgroundColor: anomalyData.colors,
                                borderColor: '#FFFFFF',
                                borderWidth: 3,
                                cutout: '75%',
                                hoverOffset: 15,
                                hoverBorderWidth: 4
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false
                            },
                            plugins: { 
                                legend: { display: false }, 
                                tooltip: { 
                                    enabled: true,
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed;
                                            const percentage = ((value / totalAnomalies) * 100).toFixed(1);
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 1000
                            },
                            elements: {
                                arc: {
                                    borderWidth: 2
                                }
                            }
                        }
                    });
                }

                // Create Stacked Bar Chart with dynamic data
                const stackedBarCtx = document.getElementById('stackedBarChart');
                if (stackedBarCtx) {
                    const stackedBarData = {
                        labels: {{ bar_chart_data.labels|default(['Block 1', 'Block 2', 'Block 3', 'Block 4', 'Block 5', 'Block 6', 'Block 7', 'Block 8'])|tojson }},
                        datasets: {{ bar_chart_data.datasets|default([
                            { 'label': 'Bypass Diode', 'data': [15, 12, 8, 20, 6, 15, 8, 11], 'backgroundColor': '#5D9CFC' },
                            { 'label': 'Multi Cell', 'data': [10, 8, 12, 6, 8, 10, 12, 8], 'backgroundColor': '#9867F1' },
                            { 'label': 'Cell', 'data': [8, 6, 10, 4, 6, 8, 10, 6], 'backgroundColor': '#EC61A6' },
                            { 'label': 'Vegetation', 'data': [5, 3, 6, 2, 3, 5, 6, 3], 'backgroundColor': '#F58700' },
                            { 'label': 'Physical Damage', 'data': [3, 2, 4, 1, 2, 3, 4, 2], 'backgroundColor': '#F2C94C' },
                            { 'label': 'Short Circuit', 'data': [2, 1, 2, 3, 1, 2, 1, 2], 'backgroundColor': '#47C878' },
                            { 'label': 'String Offline', 'data': [3, 2, 3, 4, 2, 3, 2, 3], 'backgroundColor': '#dc3545' },
                            { 'label': 'Module Offline', 'data': [4, 3, 4, 5, 3, 4, 3, 4], 'backgroundColor': '#17a2b8' }
                        ])|tojson }}
                    };

                    const barLegend = document.getElementById('bar-chart-legend');
                    if (barLegend) {
                        barLegend.innerHTML = '';
                        stackedBarData.datasets.forEach(d => {
                            barLegend.innerHTML += `<div class="legend-item"><div class="legend-color" style="background-color: ${d.backgroundColor}"></div><span>${d.label}</span></div>`;
                        });
                    }

                    new Chart(stackedBarCtx, {
                        type: 'bar',
                        data: stackedBarData,
                        options: {
                            responsive: true, 
                            maintainAspectRatio: false,
                            animation: {
                                duration: 1000,
                                easing: 'easeInOutCubic'
                            },
                            plugins: { 
                                legend: { display: false }, 
                                tooltip: { 
                                    mode: 'index', 
                                    intersect: false,
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: 'rgba(255,255,255,0.1)',
                                    borderWidth: 1,
                                    cornerRadius: 6,
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label + ' - Total Anomalies';
                                        }
                                    }
                                }
                            },
                            scales: { 
                                x: { 
                                    stacked: true, 
                                    grid: { display: false },
                                    categoryPercentage: 0.6,
                                    barPercentage: 0.8,
                                    title: {
                                        display: true,
                                        text: 'Blocks',
                                        font: { weight: 'bold', size: 12 },
                                        color: '#374151'
                                    },
                                    ticks: {
                                        color: '#6B7280',
                                        font: { size: 11 }
                                    }
                                }, 
                                y: { 
                                    stacked: true, 
                                    beginAtZero: true, 
                                    title: {
                                        display: true,
                                        text: 'Total Anomalies',
                                        font: { weight: 'bold', size: 12 },
                                        color: '#374151'
                                    },
                                    ticks: { 
                                        stepSize: 5,
                                        color: '#6B7280',
                                        font: { size: 11 }
                                    },
                                    grid: {
                                        color: '#F3F4F6',
                                        lineWidth: 1
                                    }
                                } 
                            },
                            elements: { 
                                bar: { 
                                    borderRadius: { topLeft: 3, topRight: 3 },
                                    borderSkipped: false
                                } 
                            },
                            layout: {
                                padding: {
                                    left: 10,
                                    right: 10,
                                    top: 10,
                                    bottom: 10
                                }
                            }
                        }
                    });
                }

            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        });

        // Sidebar toggle function
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('mobile-visible');
        }

        // Chart toggle functions
        function showAnomalyChart() {
            document.getElementById('anomalyChartSection').classList.add('active');
            document.getElementById('severityChartSection').classList.remove('active');
            document.querySelectorAll('.chart-toggle-btn')[0].classList.add('active');
            document.querySelectorAll('.chart-toggle-btn')[1].classList.remove('active');
        }

        function showSeverityChart() {
            document.getElementById('anomalyChartSection').classList.remove('active');
            document.getElementById('severityChartSection').classList.add('active');
            document.querySelectorAll('.chart-toggle-btn')[0].classList.remove('active');
            document.querySelectorAll('.chart-toggle-btn')[1].classList.add('active');

            // Create severity chart if not exists
            createSeverityChart();
        }

        // Create severity bar chart
        function createSeverityChart() {
            const severityCtx = document.getElementById('severityBarChart');
            if (severityCtx && !severityCtx.chart) {
                const severityChartData = {
                    labels: ['Block 1', 'Block 2', 'Block 3', 'Block 4', 'Block 5', 'Block 6', 'Block 7', 'Block 8'],
                    datasets: [
                        { 
                            label: 'High Severity', 
                            data: [8, 6, 4, 12, 3, 8, 4, 6], 
                            backgroundColor: '#FF0000' 
                        },
                        { 
                            label: 'Medium Severity', 
                            data: [12, 9, 8, 15, 7, 12, 8, 10], 
                            backgroundColor: '#FF914D' 
                        },
                        { 
                            label: 'Low Severity', 
                            data: [6, 4, 5, 8, 3, 6, 5, 4], 
                            backgroundColor: '#008000' 
                        }
                    ]
                };

                const severityLegend = document.getElementById('severity-chart-legend');
                if (severityLegend) {
                    severityLegend.innerHTML = '';
                    severityChartData.datasets.forEach(d => {
                        severityLegend.innerHTML += `<div class="legend-item"><div class="legend-color" style="background-color: ${d.backgroundColor}"></div><span>${d.label}</span></div>`;
                    });
                }

                severityCtx.chart = new Chart(severityCtx, {
                    type: 'bar',
                    data: severityChartData,
                    options: {
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false }, 
                            tooltip: { 
                                mode: 'index', 
                                intersect: false
                            }
                        },
                        scales: { 
                            x: { 
                                stacked: true, 
                                grid: { display: false },
                                title: {
                                    display: true,
                                    text: 'Blocks',
                                    font: { weight: 'bold', size: 12 },
                                    color: '#374151'
                                }
                            }, 
                            y: { 
                                stacked: true, 
                                beginAtZero: true, 
                                title: {
                                    display: true,
                                    text: 'Severity Count',
                                    font: { weight: 'bold', size: 12 },
                                    color: '#374151'
                                }
                            } 
                        }
                    }
                });
            }
        }

        // Navigation functions
        function openAnomaliesMap() {
            const plantId = '{{ plant._id }}';
            // Try to get the first audit for this plant and redirect to its anomalies
            fetch(`/api/plants/${plantId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.plant.audits && data.plant.audits.length > 0) {
                        // Redirect to the first audit's detail page
                        window.location.href = '/audit/' + data.plant.audits[0];
                    } else {
                        // Fallback to plant detail page
                        window.location.href = '/plant/' + plantId;
                    }
                })
                .catch(error => {
                    console.error('Error fetching plant data:', error);
                    // Fallback to plant detail page
                    window.location.href = '/plant/' + plantId;
                });
        }

        function openSiteDetails() {
            const plantId = '{{ plant._id }}';
            window.location.href = '/plant/' + plantId + '/site-details';
        }

        function openSeverityMap() {
            const plantId = '{{ plant._id }}';
            window.location.href = '/plant/' + plantId + '/severity-map';
        }

        // Toggle user dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdown');
            const userBtn = event.target.closest('.user-btn');
            
            if (!userBtn && !dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Handle window resize for responsive charts
        window.addEventListener('resize', function() {
            Chart.helpers.each(Chart.instances, function(instance) {
                instance.resize();
            });
        });
    </script>
</body>

</html>
